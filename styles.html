<style>
/* =========================
   Theme tokens
   ========================= */
:root{
  --mustard:#EAD999; --sunset:#F4D1C4; --terracotta:#F0BBA9; --rust:#C89076;
  --sage:#E3E7D5; --olive:#A6AD66;

  --bg:#EDE9E3; --panel:#F7F4EE; --muted:#8A857A; --text:#3E3A33;
  --overlay:rgba(0,0,0,.20); --panel-border:#DDD4C6; --accent:var(--olive);

  /* sticky offsets (JS updates these) */
  --stickytop: 56px;
  --seg-h: 40px;
  --filters-h: 48px;
}
*{ box-sizing:border-box; }

body{
  margin:0;
  font-family:"Book Antiqua", Palatino, "Palatino Linotype", serif;
  font-size:14px; line-height:1.4;
  background:var(--bg); color:var(--text);
}

/* ========================= Layout ========================= */
.container{ max-width:1100px; margin:24px auto; padding:0 16px; }
.app-header{ position:sticky; top:0; z-index:1000; backdrop-filter:saturate(1.05) blur(2px);
  background:var(--bg); padding:8px 0; }
.cards{ display:grid; grid-template-columns:1fr; gap:16px; }

.card{ background:var(--panel); border:1px solid var(--panel-border); border-radius:16px;
  padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
.card h2{ margin:0 0 12px 0; background:#E4DECF; padding:8px 12px; border-radius:10px;
  display:flex; align-items:center; gap:8px; }
.row{ display:flex; gap:8px; align-items:center; margin-top:8px; }

.bunny-home {
  text-decoration: none;
  color: inherit;
  margin-right: 6px;
  cursor: pointer;
}

.bunny-home:hover {
  opacity: 0.7;
}

/* Generic two-column layout for dashboard sections */
.two-col{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
@media (max-width:640px){
  .two-col{ grid-template-columns:1fr; }
}


/* Summary containers */
.summary-flex-final{ display:flex; gap:12px; width:100%; }
.summary-flex-final > .summary-col{ flex:1 1 0; }

/* Forms */
.form input,.form select{
  width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--panel-border);
  background:var(--panel); color:var(--text);
}

/* Filter rows */
.filter-row{ display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; margin-top:8px; }
.filter-row label{ font-weight:500; color:var(--muted); }
.filter-row select{ width:200px; flex-grow:1; }
.filter-row button{ flex-grow:1; margin-left:auto; }
.filter-row.compact{ gap:8px; margin-top:4px; align-items:center; }
.filter-row.compact label{ font-weight:600; }
.filter-row.compact select{ width:180px; max-width:220px; }
.flex-spacer{ flex:1 1 auto; }

/* Tabs */
.seg{ display:flex; gap:8px; align-items:center; margin:8px 0 6px; }
.seg-btn{
  border:1px solid var(--panel-border);
  background:#efe9db;
  padding:6px 10px;
  border-radius:10px;
  font-weight:600;
}
.seg-btn.active{ background:#e4decf; }
.seg-btn.ghost{ background:transparent; }

/* Section titles */
.table-title{ margin:12px 0 8px 0; font-size:16px; font-weight:700; letter-spacing:.2px;
  color:var(--text); background:#E4DECF; padding:6px 10px; border-radius:8px; }

/* ========================= Tables ========================= */
table{ width:100%; border-collapse:collapse; font-size:13px; background:var(--panel);
  border-radius:12px; overflow:hidden; }
th,td{ padding:8px 10px; border-bottom:1px solid var(--panel-border); }
th{ background:#E4DECF; text-align:left; }
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.table-wrap table{ min-width:0; }
.table-wrap th{ position:sticky; top:0; z-index:1; background:#E4DECF; }

table tbody tr:hover{ background:#F3EEDD; }

/* ========================= Buttons ========================= */
button{
  padding:8px 12px; border-radius:10px; border:1px solid var(--panel-border);
  background:#E4DECF; color:var(--text); cursor:pointer; transition:all .2s ease-in-out;
}
button:hover{ border-color:var(--accent); background:#DBD3C2; }
button.action{ height:36px; padding:6px 12px; font-weight:600; border-radius:10px; }

button.busy{
  font-weight:700; letter-spacing:.2px; transform:translateY(-1px);
  box-shadow:0 0 0 0 rgba(166,173,102,.35);
  animation:btn-pulse 1100ms ease-in-out infinite, btn-wiggle 1200ms ease-in-out infinite;
}
@keyframes btn-pulse{
  0%{ box-shadow:0 0 0 0 rgba(166,173,102,.35); }
  70%{ box-shadow:0 0 12px 6px rgba(166,173,102,.2); }
  100%{ box-shadow:0 0 0 0 rgba(166,173,102,0); }
}
@keyframes btn-wiggle{
  0%{ transform: translateY(-1px) rotate(0); }
  30%{ transform: translateY(-1px) rotate(-1.5deg); }
  60%{ transform: translateY(-1px) rotate(1.5deg); }
  100%{ transform: translateY(-1px) rotate(0); }
}

/* ========================= KPI HERO ========================= */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
.kpi-card {
  background: #fff;
  padding: 16px 12px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  border: 1px solid rgba(0,0,0,0.04);
}
.kpi-label { font-size: 0.85rem; opacity: 0.7; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.kpi-value { font-size: 1.4rem; font-weight: 800; margin-top: 4px; color: var(--ink); }

/* KPI Colors */
.kpi-card.income .kpi-value { color: var(--olive); }
.kpi-card.expense .kpi-value { color: var(--rust); }
.kpi-card.net .kpi-value { color: var(--text); }

/* ========================= Modal ========================= */
.hidden{ display:none !important; }
.modal{ position:fixed; inset:0; display:grid; place-items:center; background:var(--overlay);
  z-index:9999; backdrop-filter:saturate(1.1); }
.modal-panel{
  background:#EDE7DC; color:var(--text); border:1px solid var(--panel-border); border-radius:16px;
  max-width:92vw; padding:12px 20px; box-shadow:0 10px 30px rgba(0,0,0,.15);
  display:flex; flex-direction:row; align-items:center; justify-content:center; text-align:left; gap:16px;
}
.bunny{ font-size:34px; line-height:1; animation:bunny-hop 900ms cubic-bezier(.2,.7,.3,1) infinite; }
.modal-text{ font-size:15px; color:var(--text); }
@keyframes bunny-hop{
  0%{ transform: translateY(0) scale(1); }
  30%{ transform: translateY(-6px) scale(1.05); }
  55%{ transform: translateY(0) scale(1); }
  75%{ transform: translateY(-3px) scale(1.03); }
  100%{ transform: translateY(0); }
}

/* Softer controls */
input,select,button{ color:#5c554c; }
input::placeholder, select option[value=""], select option:disabled{ color:#8c867e; }
input[type="month"]{ color:#5c554c; }
input:focus, select:focus, button:focus{ color:var(--text); border-color:var(--accent); }

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  .bunny, button.busy{ animation:none; transform:none; }
}

/* ========================= Responsive ========================= */
@media (max-width: 900px){
  .cards{ grid-template-columns:1fr; }
  .grid{ grid-template-columns:1fr; }
}

/* Phone breakpoint */
@media (max-width: 640px){
  body{ font-size:17px; line-height:1.5; }
  .container{ padding:0 12px; }
  .card{ padding:12px; }
  
  /* KPI Stack compact on phones */
  .kpi-value { font-size: 1.15rem; }
  .kpi-grid { gap: 8px; }

  #qaForm { gap: 8px; }
  #qaForm label { font-size: 12px; }
  #qaForm input, #qaForm select, #qaForm button { height: 48px; font-size: 16px; }

  /* Summary two-up */
  #summaryArea.summary-flex-final{
    display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px;
  }
  #summaryArea .summary-col{ min-width:0; }

  .card h2{ font-size:18px; }

  /* Filters tidy */
  .filter-row{ gap:8px; }
  .filter-row label{ font-size:12px; }
  .filter-row select{ width:100%; max-width:none; }
  .filter-row.compact .field{ width:100%; }
  .flex-spacer{ display:none; }

  /* Thumb targets */
  input, select, button{ height:48px; font-size:16px; }
  button.action{ height:48px; }

  /* Cells */
  th, td{ padding:10px 12px; }

  /* Transactions: hide Account (2) + Description (6) */
  #dxTx thead th:nth-child(2),
  #dxTx tbody td:nth-child(2),
  #dxTx thead th:nth-child(6),
  #dxTx tbody td:nth-child(6){ display:none; }

  /* Shimmer skin */
  .shimmer{ position:relative; overflow:hidden; background:#eee; }
  .shimmer::after{
    content:""; position:absolute; inset:0; transform:translateX(-100%);
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);
    animation:shimmer 1.2s infinite;
  }
  body.bb-busy .table-wrap{ min-height:56px; border-radius:8px; background:#efede7; }

  /* Tabs NOT sticky on phones */
  .seg{ position: static; top: auto; }

  #panel-bud.hidden, #panel-tx.hidden{ display:none !important; }
}

@keyframes shimmer{ 100%{ transform: translateX(100%); } }

/* ===========================================================
   BBB: TABLE-LOCAL STICKY v2 — section-local sticky (desktop)
   =========================================================== */

.seg{ position: static !important; top: auto !important; }
.filter-row.compact.original{ position: static !important; top: auto !important; box-shadow:none !important; }

.panel{ margin-top:12px; }
.panel > summary.table-title{
  display:flex; align-items:center; gap:8px; padding:6px 10px; background:#E4DECF; border-radius:8px;
}
.panel > summary.table-title::-webkit-details-marker{ display:none; }
.panel[open] > summary.table-title{ border-bottom-left-radius:8px; border-bottom-right-radius:8px; }

#panel-bud .table-wrap,
#panel-tx  .table-wrap{
  position: relative;
  max-height: none;               /* no inner scroll container */
  overflow: visible;              /* let the page scroll instead */
  -webkit-overflow-scrolling: auto;
}

#panel-bud .table-wrap table,
#panel-tx  .table-wrap table{
  border-collapse: separate !important;  /* critical for sticky in Chrome/Safari */
  border-spacing: 0 !important;
  overflow: visible !important;          /* undo global overflow:hidden */
}
#panel-bud .table-wrap thead th,
#panel-tx  .table-wrap thead th{
  position: sticky !important;
  top: 0 !important;                      /* stick to wrapper top (desktop) */
  z-index: 3;
  background: #E4DECF;
}

/* ===========================================================
   BBB: TABLE-LOCAL STICKY v3 — mobile page-scroll sticky
   =========================================================== */
@media (max-width: 640px), (hover: none) and (pointer: coarse){
  /* Wrappers do not scroll on phones — page scroll instead */
  #panel-bud .table-wrap,
  #panel-tx  .table-wrap{
    max-height: none !important;
    overflow: visible !important;
  }

  /* Table headers stick to the viewport under the app header */
  #panel-bud .table-wrap thead th,
  #panel-tx  .table-wrap thead th{
    position: sticky !important;
    top: var(--stickytop) !important;
    z-index: 3;
    background: #E4DECF;
  }

  /* Neutralize any generic top:0 rule on phones */
  .table-wrap th{ top: var(--stickytop) !important; }
}

/* Mobile jump chip */
.mobile-jump{ display:flex; justify-content:flex-end; margin:4px 0 8px; }
.mobile-jump .chip-link{
  display:inline-block; padding:6px 10px; border:1px solid var(--panel-border);
  border-radius:999px; background:#efe9db; text-decoration:none; color:var(--text);
  font-weight:600; font-size:13px;
}

/* BBB: HOTFIX — scope mobile sticky to Explorer only */
@media (max-width: 640px), (hover: none) and (pointer: coarse){

  /* Undo any previous global top override */
  .table-wrap th{
    top: 0 !important;
  }

  /* Apply viewport-sticky ONLY to Explorer sections */
  #panel-bud .table-wrap thead th,
  #panel-tx  .table-wrap thead th{
    top: var(--stickytop) !important;   /* below the sticky app header */
    position: sticky !important;
  }

  /* Summary tables: NO sticky at all on mobile */
  #summaryArea .table-wrap th,
  #summaryArea .table-wrap thead th{
    position: static !important;
    top: auto !important;
    z-index: auto !important;
  }
}

/* =========================
   Tablet enhancements (Xiaomi Pad 7, iPad class)
   641px–1100px
   ========================= */
@media (min-width: 641px) and (max-width: 1100px){
  .card{ padding:20px 18px; }
  input, select, button{ min-height:44px; padding:10px 14px; font-size:15px; }
  .filter-row{ gap:10px 16px; }
  .summary-flex-final{ gap:16px; }
  .summary-flex-final > .summary-col{ min-width:0; }
  .table-title{ font-size:17px; }
  th,td{ padding:9px 12px; }
}
</style>