<?!= include('styles'); ?>
<div class="container">
  <header class="app-header">
    <h1>🐰 Bunny Balut Budget</h1>
    <div class="sub">Daddy owns you, and your budget 🐾🐾</div>
  </header>

    <div id="busyModal" class="modal hidden" role="dialog" aria-modal="true" aria-live="polite">
    <div class="modal-panel">
      <div class="bunny" aria-hidden="true">🐰</div>
      <div class="modal-text">Hang on to your Bunny Hairs, Daddy is getting the info...</div>
    </div>
  </div>

  <section class="cards">
    <div class="card">
      <h2>🧮 Summary</h2>
      <div class="row">
        <label for="isoMonth">Month</label>
        <input type="month" id="isoMonth" />
        <button id="btnApplyMonth" class="action">Set Month</button>
        <label class="inline" style="margin-left:8px;"><input type="checkbox" id="includeTx" checked> Include Transactions</label>
        <span id="monthStatus" class="status"></span>
      </div>

            <div id="summaryArea" class="summary-flex-final" style="margin-top:10px">
        <div class="summary-col"><h3>Actual vs Budget</h3><table id="tblActVsBud"></table></div>
        <div class="summary-col"><h3>Income</h3><table id="tblIncome"></table></div>
        <div class="summary-col"><h3>Expense</h3><table id="tblExpense"></table></div>
      </div>
          </div>
  </section>

  
<div class="card">
  <h2>🔎 Bunny Data Explorer</h2>

  <div class="row"><span id="dxMonthBadge" class="chip">Month Set: not set</span></div>

  <h3>Data Filters</h3>
  <!-- Compact filters -->
  <div class="filter-row compact">
    <label for="dxType">Type</label>
    <select id="dxType"></select>

    <label for="dxCat">Category</label>
    <select id="dxCat"></select>

    <span class="flex-spacer"></span>
    <button id="dxRefresh" class="action">Refresh Transactions</button>
  </div>

  <h3 class="table-title">Budget</h3>
  <table id="dxBudgets"></table>

  <h3 class="table-title" style="margin-top:16px">Transactions</h3>
  <table id="dxTx"></table>
</div>



  <?!= include('client'); ?>
</div>

<script>
(function () {
  const $ = (id) => document.getElementById(id);

  const btn  = $('btnApplyMonth') || $('applyButton');
  const iMonth = $('isoMonth') || $('monthSelect');
  const status = $('monthStatus');
  if (!btn) return;

  function readMonthISO() {
    if (!iMonth) return '';
    if (iMonth.type === 'month') return iMonth.value || '';
    const mm = String(iMonth.value || '').padStart(2, '0');
    const yyyy = new Date().getFullYear();
    return mm ? `${yyyy}-${mm}` : '';
  }

  btn.addEventListener('click', () => {
    const iso = readMonthISO();
    if (!iso) { alert('Please select a month first.'); return; }

    const prev = btn.textContent;
    btn.textContent = 'Good Girrrrrl ✨';
    btn.classList.add('busy');

    // --- This is the correct modal logic ---
    showBusy(); 
    if (status) status.textContent = '';
    // --- End modal logic ---

    google.script.run
.withSuccessHandler((res) => {
  btn.textContent = prev;
  btn.classList.remove('busy');

  // We correctly removed the 'hide modal' call from here

  if (status) status.textContent = `✓ Set to ${res.b4}`;

  // Render the summary tables
  if (typeof renderTable === 'function') {
    renderTable('tblActVsBud', res.actVsBud);
    renderTable('tblIncome', res.income);
    renderTable('tblExpense', res.expense);
  }

// Bridge to Data Explorer
const norm = iso.replace(/^(\d{4})[-\/.](\d{1,2})$/, (_, y, m) => `${y}-${String(m).padStart(2,'0')}`);
const includeTx = !!(document.getElementById('includeTx') && document.getElementById('includeTx').checked);

// --- TWEAK 1: Pass the pretty month name ('res.b4') to the event ---
document.dispatchEvent(new CustomEvent('summary-month-set', { 
  detail: { 
    month: norm, 
    includeTx: includeTx,
    displayMonth: res.b4 // <-- ADDED THIS LINE
  } 
}));
})
      .withFailureHandler((err) => {
        btn.textContent = prev;
        btn.classList.remove('busy');
        
        hideBusy(); // Correctly call this on failure
        
        const msg = (err && err.message) ? err.message : 'Unknown error';
        if (status) status.textContent = 'Error: ' + msg;
        alert('Set Month failed: ' + msg);
      })
      .setSummaryMonthFromIso(iso);
  });
})();
</script>