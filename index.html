<?!= include('styles'); ?>
<div class="container">
Â  <header class="app-header">
Â  Â  <h1>ğŸ° Bunny Balut Budget</h1>
Â  Â  <div class="sub">Daddy owns you, and your budget ğŸ¾ğŸ¾</div>
Â  </header>

Â  Â  <div id="busyModal" class="modal hidden" role="dialog" aria-modal="true" aria-live="polite">
Â  Â  <div class="modal-panel">
Â  Â  Â  <div class="bunny" aria-hidden="true">ğŸ°</div>
Â  Â  Â  <div class="modal-text">Hang on to your Bunny Hairs, Daddy is getting the info...</div>
Â  Â  </div>
Â  </div>

Â  <section class="cards">
Â  Â  <div class="card">
Â  Â  Â  <h2>Summary</h2>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <label for="isoMonth">Month</label>
Â  Â  Â  Â  <input type="month" id="isoMonth" />
Â  Â  Â  Â  <button id="btnApplyMonth">Set Month</button> <label class="inline" style="margin-left:8px;"><input type="checkbox" id="includeTx" checked> Include Transactions</label>
Â  Â  Â  Â  <span id="monthStatus" class="status"></span>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="summaryArea" class="summary-flex" style="margin-top:10px">
Â  Â  Â  Â  <div><h3>Actual vs Budget</h3><table id="tblActVsBud"></table></div>
Â  Â  Â  Â  <div><h3>Income</h3><table id="tblIncome"></table></div>
Â  Â  Â  Â  <div><h3>Expense</h3><table id="tblExpense"></table></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â Â 
Â  Â  <div class="card">
Â  Â  Â  <h2>Bunny Data Explorer</h2>
Â  Â  Â  <div class="row"><span id="dxMonthBadge" class="chip">Month: not set</span></div>

Â  Â  Â  <div class="row">
Â  Â  Â  Â  <label for="dxType">Type</label>
Â  Â  Â  Â  <select id="dxType"></select>
Â  Â  Â  Â  <label for="dxCat">Category</label>
Â  Â  Â  Â  <select id="dxCat"></select>
Â  Â  Â  Â  <button id="dxRefresh">Get Transactions</button>
Â  Â  Â  </div>

Â  Â  Â  <div class="row" style="margin-top:10px">
Â  Â  Â  Â  <strong>Budget</strong>
Â  Â  Â  </div>
Â  Â  Â  <table id="dxBudgets"></table>

Â  Â  Â  <div class="row" style="margin-top:16px"> Â  Â  Â  Â  <strong>Transactions</strong>
Â  Â  Â  Â  <span id="dxPageInfo" class="status"></span>
Â  Â  Â  Â  <span style="margin-left:auto"></span>
Â  Â  Â  Â  <button id="dxPrev">Prev</button>
Â  Â  Â  Â  <button id="dxNext">Next</button>
Â  Â  Â  </div>
Â  Â  Â  <table id="dxTx"></table>
Â  Â  </div>


Â  <?!= include('client'); ?>
</div>

<script>
(function () {
Â  const $ = (id) => document.getElementById(id);

Â  const btnÂ  = $('btnApplyMonth') || $('applyButton');
Â  const iMonth = $('isoMonth') || $('monthSelect');
Â  const status = $('monthStatus');
Â  if (!btn) return;

Â  function readMonthISO() {
Â  Â  if (!iMonth) return '';
Â  Â  if (iMonth.type === 'month') return iMonth.value || '';
Â  Â  const mm = String(iMonth.value || '').padStart(2, '0');
Â  Â  const yyyy = new Date().getFullYear();
Â  Â  return mm ? `${yyyy}-${mm}` : '';
Â  }

Â  btn.addEventListener('click', () => {
Â  Â  const iso = readMonthISO();
Â  Â  if (!iso) { alert('Please select a month first.'); return; }

Â  Â  const prev = btn.textContent;
Â  Â  btn.textContent = 'Good Girrrrrl âœ¨';
Â  Â  btn.classList.add('busy');

Â  Â  // --- This is the correct modal logic ---
Â  Â  showBusy(); 
Â  Â  if (status) status.textContent = '';
Â  Â  // --- End modal logic ---

Â  Â  google.script.run
.withSuccessHandler((res) => {
Â  btn.textContent = prev;
Â  btn.classList.remove('busy');

Â  // We correctly removed the 'hide modal' call from here

Â  if (status) status.textContent = `âœ“ Set to ${res.b4}`;

Â  // Render the summary tables
Â  if (typeof renderTable === 'function') {
Â  Â  renderTable('tblActVsBud', res.actVsBud);
Â  Â  renderTable('tblIncome', res.income);
Â  Â  renderTable('tblExpense', res.expense);
Â  }

// Bridge to Data Explorer
const norm = iso.replace(/^(\d{4})[-\/.](\d{1,2})$/, (_, y, m) => `${y}-${String(m).padStart(2,'0')}`);
const includeTx = !!(document.getElementById('includeTx') && document.getElementById('includeTx').checked);

// Fire ONE event that other scripts can listen for
document.dispatchEvent(new CustomEvent('summary-month-set', { detail: { month: norm, includeTx: includeTx } }));
})
Â  Â  Â  .withFailureHandler((err) => {
Â  Â  Â  Â  btn.textContent = prev;
Â  Â  Â  Â  btn.classList.remove('busy');
Â  Â  Â  Â  
Â  Â  Â  Â  hideBusy(); // Correctly call this on failure
Â  Â  Â  Â  
Â  Â  Â  Â  const msg = (err && err.message) ? err.message : 'Unknown error';
Â  Â  Â  Â  if (status) status.textContent = 'Error: ' + msg;
Â  Â  Â  Â  alert('Set Month failed: ' + msg);
Â  Â  Â  Â  // <-- Stray 'T' was removed from here
Â  Â  Â  })
Â  Â  Â  .setSummaryMonthFromIso(iso);
Â  });
})();
</script>