<meta name="viewport" content="width=device-width, initial-scale=1" />

<?!= include('styles'); ?>

<style>
#txViewToggle {
  display: none !important;
}
</style>

<div class="container">
  <header class="app-header">
    <h1>
      <a href="<?= BASE_URL ?>?view=landing" target="_top" rel="noopener" class="bunny-home">üê∞</a>
      Bunny Balut Budget
    </h1>
    <div class="sub">Daddy owns you, and your budget üêæüêæ</div>
  </header>

  <div class="mobile-jump hidden" id="jumpExplorer">
    <a href="#explorerCard" class="chip-link">Jump to Explorer ‚Üì</a>
  </div>

  <div class="card" id="monthBar">
    <div class="row">
      <strong>Pick a month, Bunny!</strong>
      <input type="month" id="isoMonth" />
      <button id="btnApplyMonth" class="action">Set Month</button>
      <label class="inline" style="margin-left:8px;">
        <input type="checkbox" id="includeTx" checked /> Include Transactions
      </label>
      <span id="monthStatus" class="status"></span>
    </div>
  </div>

  <div id="busyModal" class="modal hidden" role="dialog" aria-modal="true" aria-live="polite">
    <div class="modal-panel">
      <div class="bunny" aria-hidden="true">üê∞</div>
      <div class="modal-text">Hang on to your Bunny Hairs, Daddy is getting the info...</div>
    </div>
  </div>

  <section class="cards">
    <div class="card">
      <details id="sum-section" class="panel" open>
        <summary class="table-title">Summary</summary>

        <div id="summaryArea" class="summary-flex-final" style="margin-top:10px">
          <div class="summary-col">
            <h3>Actual vs Budget</h3>
            <div class="table-wrap"><table id="tblActVsBud"></table></div>
          </div>
          <div class="summary-col">
            <h3>Income</h3>
            <div class="table-wrap"><table id="tblIncome"></table></div>
          </div>
          <div class="summary-col">
            <h3>Expense</h3>
            <div class="table-wrap"><table id="tblExpense"></table></div>
          </div>
        </div>
      </details>
    </div>
  </section>

  <div class="card" id="explorerCard">
    <h2>üîé Bunny Data Explorer</h2>

    <div class="row">
      <span id="dxMonthBadge" class="chip">Month Set: not set</span>
    </div>

    <div class="seg seg-top" id="dxSeg">
      <button class="seg-btn" data-panel="bud">Budget</button>
      <button class="seg-btn active" data-panel="tx">Transactions</button>
      <span class="flex-spacer"></span>
      <button id="txViewToggle" class="seg-btn ghost" aria-pressed="false" title="Toggle Cards/Table">Cards</button>
    </div>

    <h3>Data Filters</h3>
    <div class="filter-row compact original" id="dxFiltersOriginal">
      <label for="dxType">Type</label>
      <select id="dxType"></select>

      <label for="dxCat">Category</label>
      <select id="dxCat"></select>

      <span class="flex-spacer"></span>
      <button id="dxRefresh" class="action">Refresh Transactions</button>
    </div>

    <details class="panel" id="bud-section">
      <summary class="table-title">Budget</summary>
      <div id="panel-bud">
        <div class="table-wrap"><table id="dxBudgets"></table></div>
      </div>
    </details>

    <details class="panel" id="tx-section" open>
      <summary class="table-title" style="margin-top:16px">Transactions</summary>
      <div id="panel-tx">
        <div class="table-wrap"><table id="dxTx"></table></div>
        <div id="dxTxCards" class="tx-cards hidden"></div>
      </div>
    </details>
  </div>

  <?!= include('client'); ?>

  
</div>

<script>
(function(){
  var card = document.getElementById('explorerCard');
  if (!card) return;
  function sizeExplorer(){
    var isDesktop = window.innerWidth >= 980;
    if (!isDesktop){
      card.style.height = '';
      card.style.overflow = '';
      return;
    }
    var top = card.getBoundingClientRect().top;
    var h   = Math.max(window.innerHeight - top, 360);
    card.style.height = h + 'px';
    card.style.overflow = 'auto';
  }
  sizeExplorer();
  window.addEventListener('resize', sizeExplorer);
  window.addEventListener('orientationchange', sizeExplorer);
  document.addEventListener('DOMContentLoaded', sizeExplorer);
  window.addEventListener('load', sizeExplorer);
})();
</script>

<script>
(function(){
  var seg      = document.getElementById('dxSeg');
  var panelBud = document.getElementById('panel-bud');
  var panelTx  = document.getElementById('panel-tx');
  var toggle   = document.getElementById('txViewToggle');
  var txTable  = document.getElementById('dxTx');
  var txCards  = document.getElementById('dxTxCards');

  if (seg && panelBud && panelTx){
    seg.addEventListener('click', function(e){
      var b = e.target.closest('.seg-btn[data-panel]');
      if (!b) return;

      var isBud      = b.getAttribute('data-panel') === 'bud';
      var panel      = isBud ? panelBud : panelTx;
      var otherPanel = isBud ? panelTx : panelBud;
      var otherBtn   = seg.querySelector('.seg-btn[data-panel="' + (isBud ? 'tx' : 'bud') + '"]');

      // Toggle this panel ON/OFF
      var turningOn = panel.classList.contains('hidden');
      if (turningOn) {
        panel.classList.remove('hidden');
        b.classList.add('active');
        b.setAttribute('aria-pressed','true');
      } else {
        // Don‚Äôt allow BOTH to be hidden ‚Äî keep at least one visible
        if (otherPanel.classList.contains('hidden')) return;
        panel.classList.add('hidden');
        b.classList.remove('active');
        b.setAttribute('aria-pressed','false');
      }
    });
  }

  function buildCardsFromTable(){
    if (!txTable || !txCards) return;
    var thead = txTable.tHead;
    var tbody = txTable.tBodies[0];
    if (!thead || !tbody || !thead.rows.length) {
      txCards.innerHTML = '';
      return;
    }

    var heads = Array.from(thead.rows[0].cells).map(c => (c.textContent||'').trim().toLowerCase());
    var idx = {
      date:      heads.findIndex(h => /date/.test(h)),
      type:      heads.findIndex(h => /^type$/.test(h)),
      category:  heads.findIndex(h => /category/.test(h)),
      amount:    heads.findIndex(h => /amount/.test(h))
    };

    txCards.innerHTML = '';
    Array.from(tbody.rows).forEach(function(r){
      var d = (idx.date>=0 && r.cells[idx.date]) ? r.cells[idx.date].textContent.trim() : '';
      var t = (idx.type>=0 && r.cells[idx.type]) ? r.cells[idx.type].textContent.trim() : '';
      var c = (idx.category>=0 && r.cells[idx.category]) ? r.cells[idx.category].textContent.trim() : '';
      var a = (idx.amount>=0 && r.cells[idx.amount]) ? r.cells[idx.amount].textContent.trim() : '';

      var card = document.createElement('div');
      card.className = 'tx-card ' + ((/income/i.test(t)) ? 'income' : (/expense/i.test(t) ? 'expense' : ''));
      var main = document.createElement('div'); main.className='tx-main'; main.textContent = c || t || '‚Äî';
      var sub  = document.createElement('div'); sub.className='tx-sub';  sub.textContent = d + (t ? ' ¬∑ ' + t : '');
      var amt  = document.createElement('div'); amt.className='tx-amt';  amt.textContent = a || '';

      card.appendChild(main);
      card.appendChild(amt);
      card.appendChild(sub);

      txCards.appendChild(card);
    });
  }

  if (toggle && panelTx){
    toggle.addEventListener('click', function(){
      var on = toggle.getAttribute('aria-pressed') === 'true' ? false : true;
      toggle.setAttribute('aria-pressed', String(on));
      toggle.textContent = on ? 'Table' : 'Cards';
      var wrap = txTable && txTable.closest('.table-wrap');

      if (on){
        buildCardsFromTable();
        txCards.classList.remove('hidden');
        if (wrap) wrap.classList.add('hidden');
      }else{
        txCards.classList.add('hidden');
        if (wrap) wrap.classList.remove('hidden');
      }
    });
  }

  document.addEventListener('summary-month-set', function(){
    if (toggle && toggle.getAttribute('aria-pressed') === 'true'){
      setTimeout(buildCardsFromTable, 250);
    }
  });
  document.addEventListener('dx-refresh-complete', function(){
    if (toggle && toggle.getAttribute('aria-pressed') === 'true'){
      setTimeout(buildCardsFromTable, 150);
    }
  });
})();
</script>

<script>
(function () {
  const $ = (id) => document.getElementById(id);

  const btn    = $('btnApplyMonth') || $('applyButton');
  const iMonth = $('isoMonth')      || $('monthSelect');
  const status = $('monthStatus');
  if (!btn) return;

  function readMonthISO() {
    if (!iMonth) return '';
    if (iMonth.type === 'month') return iMonth.value || '';
    const mm = String(iMonth.value || '').padStart(2, '0');
    const yyyy = new Date().getFullYear();
    return mm ? `${yyyy}-${mm}` : '';
  }

  btn.addEventListener('click', () => {
    const iso = readMonthISO();
    if (!iso) { alert('Please select a month first.'); return; }

    const prev = btn.textContent;
    btn.textContent = 'Good Girrrrrl ‚ú®';
    btn.classList.add('busy');

    showBusy();
    if (status) status.textContent = '';

    google.script.run
      .withSuccessHandler((res) => {
        btn.textContent = prev;
        btn.classList.remove('busy');

        if (status) status.textContent = `‚úì Set to ${res.b4}`;

        const sum      = document.getElementById('sum-section');
        const explorer = document.getElementById('explorerCard');
        const isPhone  = window.matchMedia('(max-width: 640px), (hover:none) and (pointer:coarse)').matches;

        // On tablet/desktop, open Summary; on phones, collapse it
        if (sum) {
          if (isPhone) {
            sum.removeAttribute('open');   // hide Summary cards by default on phones
          } else {
            sum.open = true;
          }
        }

        // On phones, after setting the month, jump the user down to Explorer
        if (isPhone && explorer) {
          explorer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        if (typeof renderTable === 'function') {
          renderTable('tblActVsBud', res.actVsBud);
          renderTable('tblIncome',   res.income);
          renderTable('tblExpense',  res.expense);
        }

        const norm = iso.replace(/^(\d{4})[-\/.](\d{1,2})$/, (_, y, m) => `${y}-${String(m).padStart(2,'0')}`);
        const includeTx = !!(document.getElementById('includeTx') && document.getElementById('includeTx').checked);

        document.dispatchEvent(new CustomEvent('summary-month-set', {
          detail: { month: norm, includeTx: includeTx, displayMonth: res.b4 }
        }));
      })
      .withFailureHandler((err) => {
        btn.textContent = prev;
        btn.classList.remove('busy');

        hideBusy();

        const msg = (err && err.message) ? err.message : 'Unknown error';
        if (status) status.textContent = 'Error: ' + msg;
        alert('Set Month failed: ' + msg);
      })
      .setSummaryMonthFromIso(iso);
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  if (location.hash === '#qaForm') {
    const el = document.getElementById('qaForm');
    if (el) { el.scrollIntoView({behavior:'smooth', block:'start'}); }
    const amt = document.getElementById('qaAmt');
    if (amt) { try { amt.focus(); } catch(_){} }
  }
});
</script>

<script>
(function(){
  function setStickyOffsets(){
    var root    = document.documentElement;
    var header  = document.querySelector('.app-header');
    var seg     = document.getElementById('dxSeg');
    var filters = document.getElementById('dxFiltersOriginal');

    var headerH = header  ? header.getBoundingClientRect().height  : 0;
    var segH    = seg     ? seg.getBoundingClientRect().height     : 0;
    var filtH   = filters ? filters.getBoundingClientRect().height  : 0;

    root.style.setProperty('--stickytop', Math.round(headerH) + 'px');
    root.style.setProperty('--seg-h',     Math.round(segH)    + 'px');
    root.style.setProperty('--filters-h', Math.round(filtH)   + 'px');
  }

  setStickyOffsets();
  window.addEventListener('resize', setStickyOffsets);
  window.addEventListener('orientationchange', setStickyOffsets);
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(setStickyOffsets).catch(()=>{});
  }
})();
</script>

<script>
(function(){
  function clearSectionWrap(panelId){
    var panel = document.getElementById(panelId);
    if (!panel) return;
    var wrap = panel.querySelector('.table-wrap');
    if (!wrap) return;

    // Remove any JS-set sizing/overflow so the page scrolls normally
    wrap.style.maxHeight = '';
    wrap.style.overflow  = '';
    wrap.style.webkitOverflowScrolling = '';
  }
  function clearAll(){
    clearSectionWrap('panel-bud');
    clearSectionWrap('panel-tx');
  }
  clearAll();
  window.addEventListener('resize', clearAll, {passive:true});
  window.addEventListener('orientationchange', clearAll, {passive:true});
  document.addEventListener('DOMContentLoaded', clearAll);
  window.addEventListener('load', clearAll);
  document.addEventListener('summary-month-set', clearAll);
  document.addEventListener('dx-refresh-complete', clearAll);
})();
</script>

<script>
(function(){
  function ensureStickyThead(tableId){
    var table = document.getElementById(tableId);
    if (!table) return;
    if (table.tHead && table.tHead.rows && table.tHead.rows.length) return;

    var tbody = table.tBodies && table.tBodies[0];
    var firstRow = (table.tHead && table.tHead.rows[0]) || (tbody && tbody.rows[0]) || table.rows[0];
    if (!firstRow) return;

    var thead = table.tHead || table.createTHead();
    var newHeadRow = thead.insertRow(0);
    Array.from(firstRow.cells).forEach(function(cell){
      var th = document.createElement('th');
      th.innerHTML = cell.innerHTML;
      th.className = cell.className;
      th.style.cssText = cell.style.cssText || '';
      newHeadRow.appendChild(th);
    });
    if (firstRow.parentElement === tbody || firstRow.parentElement === table) {
      firstRow.parentElement.removeChild(firstRow);
    }
  }
  function normalizeAll(){
    ensureStickyThead('dxBudgets');
    ensureStickyThead('dxTx');
  }
  document.addEventListener('DOMContentLoaded', normalizeAll);
  window.addEventListener('load', normalizeAll);
  document.addEventListener('summary-month-set', function(){ setTimeout(normalizeAll, 0); });
  document.addEventListener('dx-refresh-complete', function(){ setTimeout(normalizeAll, 0); });

  // Collapse Summary on phones by default + show jump chip
  const sum = document.getElementById('sum-section');
  const jump = document.getElementById('jumpExplorer');
  function isPhone(){
    return window.matchMedia('(max-width: 640px), (hover:none) and (pointer:coarse)').matches;
  }
  function applyMobileSummary(){
    if (!sum || !jump) return;
    if (isPhone()){
      sum.removeAttribute('open');
      jump.classList.remove('hidden');
    }else{
      sum.setAttribute('open', '');
      jump.classList.add('hidden');
    }
  }
  applyMobileSummary();
  window.addEventListener('resize', applyMobileSummary, {passive:true});
  window.addEventListener('orientationchange', applyMobileSummary, {passive:true});
})();
</script>

<script>
(function(){
  function sortTxTable(){
    var table = document.getElementById('dxTx');
    if (!table || !table.tBodies || !table.tBodies.length) return;

    var tbody = table.tBodies[0];
    var rows  = Array.from(tbody.rows || []);
    if (!rows.length) return;

    // Find Date column index from header; fallback to first column
    var dateIdx = 0;
    var thead   = table.tHead;
    if (thead && thead.rows && thead.rows.length){
      var cells = Array.from(thead.rows[0].cells || []);
      var idx   = cells.findIndex(function(c){
        return /date/i.test((c.textContent || '').trim());
      });
      if (idx >= 0) dateIdx = idx;
    }

    rows.sort(function(a, b){
      var aText = (a.cells[dateIdx] && a.cells[dateIdx].textContent || '').trim();
      var bText = (b.cells[dateIdx] && b.cells[dateIdx].textContent || '').trim();

      // Expecting yyyy-mm-dd; if parse fails, leave order
      var aDate = new Date(aText);
      var bDate = new Date(bText);
      if (isNaN(aDate) || isNaN(bDate)) return 0;

      return bDate - aDate; // newest first
    });

    // Re-append in sorted order
    rows.forEach(function(r){ tbody.appendChild(r); });
  }

  function initTxSortObserver(){
    var table = document.getElementById('dxTx');
    if (!table || !table.tBodies || !table.tBodies.length) return;

    var tbody = table.tBodies[0];

    // Initial sort
    sortTxTable();

    // Observe future changes and re-sort
    var timeoutId = null;
    var observer = new MutationObserver(function(){
      // debounce in case of batch updates
      if (timeoutId) clearTimeout(timeoutId);
      timeoutId = setTimeout(sortTxTable, 50);
    });

    observer.observe(tbody, { childList: true });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTxSortObserver);
  } else {
    initTxSortObserver();
  }
})();
</script>