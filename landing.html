<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Bunny Balut Budget</title>

  <?!= include('styles'); ?>

  <style>
    :root{
      --pad:16px;
      --radius:18px;
      --ink:#3b3532;
      --bg:#f7f4f1;
      --gap:12px;
      --card-min-svh: 22svh; /* equal-height slices */
    }

    body{ background:var(--bg); color:var(--ink); }

    /* ===== Header + wrapper ===== */
    #landing.wrap{
      display:flex; flex-direction:column;
      min-height:100svh;
      margin:0; padding:12px 12px 16px;
      box-sizing:border-box;
      max-width:1100px;
      position: relative; /* overlay stacking sanity */
    }
    .brand{ display:flex; align-items:center; gap:10px; margin:2px 0 6px; }
    .brand .bun{ font-size:clamp(1.6rem, 1.2rem + 1.8vh, 2.6rem); }
    .brand h1{
      font-weight:800; margin:0;
      font-size:clamp(1.3rem, 1rem + 2.2vh, 2.2rem);
      line-height:1.1;
    }
    .tagline{ margin:4px 0 10px; opacity:.8; font-size:clamp(.9rem, .8rem + .6vh, 1.05rem); }

    /* ===== Cards column ‚Äî mobile-first ===== */
    .cards{ display:flex; flex-direction:column; gap:var(--gap); flex:1 1 auto; min-height:0; }
    .card{
      background:#fff; border-radius:var(--radius);
      box-shadow:0 6px 18px rgba(0,0,0,.06), inset 0 0 0 1px rgba(0,0,0,.05);
      padding:18px; display:flex; flex-direction:column; justify-content:center;
      min-height:var(--card-min-svh);
      position:relative;
    }

    /* ===== Readable typography IN cards ===== */
    .kicker{ font-weight:700; opacity:.78; font-size:clamp(.85rem, .75rem + .6vh, 1rem); }
    .card h3{ margin:6px 0 8px; font-weight:800; line-height:1.25; font-size:clamp(1.1rem, .9rem + 2.0vh, 1.6rem); }
    .card p{ margin:0 0 12px; opacity:.88; line-height:1.35; font-size:clamp(.95rem, .85rem + .7vh, 1.1rem); }

    /* ===== Pills (unified typography) ===== */
    .pill, button.pill, a.pill{
      text-decoration:none !important; color:var(--ink) !important;
      display:inline-flex; align-items:center; justify-content:center;
      padding:clamp(10px, 8px + .8vh, 16px) clamp(14px, 10px + 1.2vh, 22px);
      border-radius:999px; border:1px solid rgba(0,0,0,.06);
      background:#efe9e2; font-weight:800; font-size:clamp(1rem, .9rem + .7vh, 1.125rem);
      min-height:44px;
      font-family:"Book Antiqua", Palatino, "Palatino Linotype", serif;
    }
    .pill.primary{ background:#ebd8c5; }

    /* Desktop layout */
    @media (min-width:1280px){
      .cards{ display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:16px; }
      .card{ min-height:unset; height:100%; }
    }

    /* Ribbon */
    .ribbon{
      position:absolute; right:-44px; top:12px; transform:rotate(18deg);
      padding:6px 0; width:150px; text-align:center;
      border:1px dashed rgba(0,0,0,.15);
      background:#f3edd9; color:#6a615a; font-weight:700; font-size:12px;
      pointer-events:none;
    }

    /* === Global readability bump for landing === */
    :root { font-size: 16px; }
    @media (max-width: 980px){ :root { font-size: 19px !important; } }
    @media (max-width: 640px), (hover:none) and (pointer:coarse){ :root { font-size: 20px !important; } }
    @media (max-width: 360px){ :root { font-size: 21px !important; } }

    /* Thicker text/buttons */
    #landing .kicker{ font-size: clamp(1.1rem, 0.9rem + 1.0vh, 1.25rem) !important; letter-spacing:.1px !important; }
    #landing .card h3{ font-size: clamp(1.4rem, 1.1rem + 3.2vh, 2.2rem) !important; line-height:1.28 !important; }
    #landing .card p{ font-size: clamp(1.2rem, 1.0rem + 1.2vh, 1.35rem) !important; line-height:1.5 !important; opacity:.98 !important; }
    #landing .pill, #landing button.pill, #landing a.pill{
      font-size: clamp(1.2rem, 1.05rem + 1.2vh, 1.35rem) !important;
      min-height:56px !important; padding:clamp(16px,14px + 1.4vh,22px) clamp(22px,18px + 1.6vh,30px) !important;
      border-width:2px !important; font-weight:900 !important;
    }
    #landing .card{ padding:22px 20px !important; }

    /* === QA bottom sheet ‚Äî scoped to landing === */
    #landing .qa-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:flex-end; z-index:9998;
    }
    #landing .qa-overlay.open{ display:flex; }
    #landing .qa-sheet{
      width:100%; max-height:100vh; overflow:auto; background:#fff;
      border-top-left-radius:24px; border-top-right-radius:24px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 -18px 48px rgba(0,0,0,.25);
      padding:20px 16px 22px; z-index:9999; animation:slideUp .22s ease;
      font-family:"Book Antiqua", Palatino, "Palatino Linotype", serif;
      color:var(--ink);
    }
    @keyframes slideUp{ from{transform:translateY(16px);opacity:.85} to{transform:translateY(0);opacity:1} }
    @media (min-width:980px){
      #landing .qa-overlay{ align-items:center; justify-content:center; }
      #landing .qa-sheet{ width:min(760px,92vw); max-height:86vh; border-radius:24px; }
    }

    #landing .qa-title{ font-weight:800; text-align:center; margin:10px 0 6px; font-size:clamp(1.4rem,1.1rem + 2.2vh,2rem); }
    #landing .qa-subtitle{ display:block; text-align:center; font-size:clamp(1.05rem,.95rem + 1vh,1.2rem); opacity:.95; margin-bottom:14px; }

    #landing .qa-form{ display:flex; flex-direction:column; gap:14px; }
    #landing .qa-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:480px){ #landing .qa-row{ grid-template-columns:1fr; gap:14px; } }
    #landing .qa-form label{ display:block; font-weight:800; font-size:.95rem; letter-spacing:.1px; margin:0 0 6px; opacity:.85; }

    #landing .qa-form input, #landing .qa-form select{
      width:100%; font-size:clamp(1.05rem,.95rem + .9vh,1.25rem);
      line-height:1.2; padding:16px 14px; min-height:56px;
      border-radius:16px; border:1.5px solid #c9bfb0; background:#fffdfa;
      outline:none; transition:border-color .12s, box-shadow .12s;
    }
    #landing .qa-form input:focus, #landing .qa-form select:focus{
      border-color:var(--olive); box-shadow:0 0 0 3px rgba(166,173,102,.24);
    }

    #landing .qa-actions{ display:flex; gap:10px; justify-content:space-between; margin-top:4px; }
    #landing .qa-actions .btn{
      font-family:"Book Antiqua", Palatino, "Palatino Linotype", serif;
      font-weight:800; border-radius:999px; border:2px solid rgba(0,0,0,.06);
      min-height:56px; padding:16px 20px; font-size:clamp(1.05rem,.95rem + .9vh,1.25rem);
    }
    #landing .qa-actions .btn.primary{ background:#e7d0bb; }
    #landing .qa-actions .btn.secondary{ background:#efe9e2; }

    #landing .qa-close{
      position:absolute; right:10px; top:10px; width:40px; height:40px;
      display:grid; place-items:center; border-radius:10px;
      border:1px solid rgba(0,0,0,.06); background:#f6efe8; cursor:pointer;
    }

    /* Toast */
    #landing .qa-toast{
      position:fixed; left:50%; bottom:env(safe-area-inset-bottom, 12px);
      transform:translateX(-50%); background:#2f2a25; color:#fff;
      font-weight:800; padding:10px 14px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.25); opacity:0; pointer-events:none;
      transition:opacity .18s, transform .18s;
    }
    #landing .qa-toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    /* === Easter Egg (now scoped to landing) === */
    #landing .icon-btn{
      appearance:none;border:0;background:transparent;cursor:pointer;
      font-size:1.6em; line-height:1; margin-right:8px; 
      transform-origin:center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      padding: 8px; border-radius: 12px;
    }
    #landing .icon-btn.bonk{ animation:egg-bonk .16s ease; }
    @keyframes egg-bonk{ from{transform:scale(.9) rotate(-6deg)} to{transform:scale(1) rotate(0)} }

    #landing .egg-overlay{
      position:fixed; inset:0; display:none; z-index:9997;
      background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
    }
    #landing .egg-overlay.open{ display:flex; align-items:flex-end; }

    #landing .egg-sheet{
      width:100%; max-height:90vh; overflow:auto; background:#fff;
      border-top-left-radius:22px; border-top-right-radius:22px;
      box-shadow:0 -16px 40px rgba(0,0,0,.28);
      padding:18px 16px 20px; animation:egg-up .22s ease;
    }
    @keyframes egg-up{ from{transform:translateY(14px); opacity:.9} to{transform:translateY(0); opacity:1} }
    @media (min-width:980px){
      #landing .egg-overlay{align-items:center; justify-content:center}
      #landing .egg-sheet{width:min(640px,92vw); border-radius:22px}
    }

    body.qa-open{ overflow:hidden; }

    @media (prefers-reduced-motion: reduce){
      #landing .qa-sheet{ animation:none !important; }
      #landing .qa-toast{ transition:none !important; }
      #landing .egg-sheet{ animation:none !important; }
    }

    /* === Busy animation parity with index ‚Äî for ALL landing buttons/links === */
    #landing button.busy,
    #landing a.busy,
    #landing .pill.busy,
    #landing .btn.busy,
    #landing .icon-btn.busy {
      font-weight: 700;
      letter-spacing: .2px;
      transform: translateY(-1px);
      box-shadow: 0 0 0 0 rgba(166,173,102,.35);
      animation: btn-pulse 1100ms ease-in-out infinite, btn-wiggle 1200ms ease-in-out infinite;
    }
    @keyframes btn-pulse{
      0%{ box-shadow:0 0 0 0 rgba(166,173,102,.35); }
      70%{ box-shadow:0 0 12px 6px rgba(166,173,102,.2); }
      100%{ box-shadow:0 0 0 0 rgba(166,173,102,0); }
    }
    @keyframes btn-wiggle{
      0%{ transform: translateY(-1px) rotate(0); }
      30%{ transform: translateY(-1px) rotate(-1.5deg); }
      60%{ transform: translateY(-1px) rotate(1.5deg); }
      100%{ transform: translateY(-1px) rotate(0); }
    }

    /* ====== EXTRA: Egg open animation pieces (scoped; safe) ====== */
    @media (hover:none) and (pointer:coarse) {
      .egg-top, .egg-bottom {
        fill: #fff3d9; stroke: #e7d4ac; stroke-width: 3;
        transition: transform 420ms cubic-bezier(.2,.9,.25,1);
        transform-origin: 100px 120px; /* hinge at crack line */
      }
      .egg-inner { opacity: 0; transform: translateY(6px) scale(.9); transform-origin: 100px 150px;
        transition: opacity 260ms ease-out 220ms, transform 320ms ease-out 220ms; }
      .yolk { fill: #f6b606; }
      .inner-emoji { font-size: 28px; }
      .inner-caption { font-weight: 800; font-size: 14px; fill: #3b3532; }

      .balut-splash.crack .egg-crack { animation: balutCrack 360ms ease-in-out both; }

      .balut-splash.open-egg .egg-top    { transform: translateY(-30px) rotate(-8deg); }
      .balut-splash.open-egg .egg-bottom { transform: translateY( 30px) rotate( 8deg); }
      .balut-splash.open-egg .egg-inner  { opacity: 1; transform: translateY(0) scale(1); }

      @media (prefers-reduced-motion: reduce) {
        .egg-top, .egg-bottom { transition: none !important; }
        .egg-inner { transition: none !important; }
      }
    }

    /* === Balut splash sizing (tidy, centered, not gigantic) === */
/* Hide by default; only show when .open */
.balut-splash{
  display:none;                 /* ‚Üê was grid; make it none */
  min-height:58svh;
  padding:8px 0;
  place-items:center;           /* keep for when it‚Äôs visible */
}
.balut-splash.open{
  display:grid;                 /* ‚Üê visible only when open */
  place-items:center;
}

    .balut-svg{
      width:min(82vw, 460px);  /* balanced on phones */
      height:auto;
      display:block;
    }

    .egg-top, .egg-bottom{ stroke-width:3 !important; }
    .egg-crack{ stroke-width:3.2 !important; stroke-linecap:round; stroke-linejoin:round; }
    .egg-shadow{ fill:rgba(0,0,0,.10) !important; }

    .balut-caption{
      position:static;
      text-align:center;
      margin-top:10px;
      font-weight:800;
      font-size:clamp(1.05rem, 1rem + 1vh, 1.3rem);
      opacity:.95;
    }

    /* small phones */
    @media (max-width: 360px){
      .balut-svg{ width:min(90vw, 420px); }
    }

    /* tall phones */
    @media (min-height: 720px){
      .balut-svg{ width:min(88vw, 520px); }
    }

    .qa-error {
      color: var(--sunset, #cc4444);
      font-size: 0.9rem;
      margin-top: 4px;
      min-height: 1.2em;
    }
    /* make the inline error span the full row in grid */
    #landing .qa-row .qa-error { grid-column: 1 / -1; }

  </style>
</head>

<body>
  <div id="landing" class="wrap">
    <div class="brand">
      <div class="bun">üê∞</div>
      <h1>Bunny Balut Budget</h1>
    </div>
    <p class="tagline">Daddy owns you, and your budget üêæüêæ BRAT</p>

    <!-- ü•ö BALUT SPLASH (mobile-only) -->
    <div id="balutSplash" class="balut-splash" aria-hidden="true">
      <button id="balutSkip" class="balut-skip" aria-label="Skip intro">Skip</button>

      <!-- Cracking egg that opens to reveal fun Balut bits -->
      <svg class="balut-svg" viewBox="0 0 200 260" role="img" aria-label="Balut splash">
        <defs>
          <!-- Clip the crack to the egg silhouette -->
          <clipPath id="eggClip">
            <ellipse cx="100" cy="120" rx="80" ry="110"></ellipse>
          </clipPath>

          <!-- Round mask for your photo -->
          <clipPath id="eggInnerClip">
            <circle cx="100" cy="150" r="32"></circle>
          </clipPath>

          <!-- Soft drop shadow for inner image -->
          <filter id="eggInnerShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="1.5" stdDeviation="2.2" flood-color="#000" flood-opacity="0.25"/>
          </filter>
        </defs>

        <!-- shadow -->
        <ellipse cx="100" cy="220" rx="60" ry="16" class="egg-shadow"/>

        <!-- bottom half -->
        <path class="egg-bottom" d="
          M20,120
          C20,200 180,200 180,120
          C180,210 20,210 20,120 Z" />

        <!-- top half -->
        <path class="egg-top" d="
          M20,120
          C20,40 180,40 180,120
          L180,120
          C180,70 20,70 20,120 Z" />

        <!-- Crack (stroke clipped to egg silhouette) -->
        <g clip-path="url(#eggClip)">
          <path
            d="M30,120 70,130 60,150 95,140 85,165 115,155 110,175 140,165 135,185 170,175"
            class="egg-crack"
            vector-effect="non-scaling-stroke"
          />
        </g>

        <!-- inner surprise (hidden until open) -->
        <g class="egg-inner">
          <!-- faint yolk glow behind the photo -->
          <circle cx="100" cy="150" r="30" fill="#f6b606" opacity=".22"></circle>

          <!-- YOUR IMAGE -->
          <image
            id="eggPhoto"
            x="68" y="118" width="64" height="64"
            href="https://lh3.googleusercontent.com/pw/AP1GczPG8WkMNQrx_ZOYqHsYKSGHdX42VPquhF0fYgPohai1a-StGKIJEW4EPLVMC4I67At0jRYPqWoi6kHgzykIMuK-hf2kJ1CyXu3vVt0F6GKwInCOOTTfnpKqjzoqDVACK-xTplY_ec5jmuMG9E7_ANViMQ=w454-h454-s-no-gm?authuser=0"
            xlink:href="https://lh3.googleusercontent.com/pw/AP1GczPG8WkMNQrx_ZOYqHsYKSGHdX42VPquhF0fYgPohai1a-StGKIJEW4EPLVMC4I67At0jRYPqWoi6kHgzykIMuK-hf2kJ1CyXu3vVt0F6GKwInCOOTTfnpKqjzoqDVACK-xTplY_ec5jmuMG9E7_ANViMQ=w454-h454-s-no-gm?authuser=0"
            clip-path="url(#eggInnerClip)"
            preserveAspectRatio="xMidYMid slice"
            style="filter:url(#eggInnerShadow); pointer-events:none"></image>

          <!-- Caption -->
          <text x="100" y="192" text-anchor="middle"
                class="inner-caption"
                fill="#3b3532"
                stroke="#ffffff"
                stroke-width="3"
                paint-order="stroke">
            CHOGO BALUT üòã
          </text>
        </g>
      </svg>

      <div class="balut-caption">BALUT???? üê£</div>
    </div>

    <div class="cards">
      <section class="card">
        <div class="kicker">‚ûï Quick Log</div>
        <h3>Log Your Purchase, Brat</h3>
        <p>Add a transaction fast.</p>
        <button class="pill primary" id="openQA">Open Quick Add</button>
      </section>

      <section class="card">
        <div class="kicker">üìä Dashboard</div>
        <h3>Bunny Dashboard &amp; Transactions</h3>
        <p>See Dashboard and transactions</p>
        <a class="pill primary" href="<?= BASE_URL ?>?view=index" target="_top" rel="noopener">Open Dashboard</a>
      </section>

      <section class="card">
        <div class="kicker">
          <button id="eggBunny" class="icon-btn" type="button" aria-label="Secret bunny">üê∞</button>
          Profile
        </div>
        <h3>Manage Bunny Info</h3>
        <p>Categories, accounts, preferences‚Ä¶ cozy burrow things.</p>
        <div class="ribbon">COMING SOON</div>
        <button class="pill" disabled>Soon‚Ñ¢</button>
      </section>
    </div>

    <!-- QUICK ADD (inside #landing) -->
    <div class="qa-overlay" id="qaOverlay" aria-hidden="true">
      <aside class="qa-sheet" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
        <button class="qa-close" id="qaCloseIcon" type="button" aria-label="Close">√ó</button>
        <h2 id="qaTitle" class="qa-title">Quick Add</h2>
        <small class="qa-subtitle">YAY BUNNY!</small>

        <form class="qa-form" id="qaForm">
          <div class="qa-row">
            <div>
              <label for="qaDate">Date</label>
              <input id="qaDate" type="date" required>
            </div>
            <div>
              <label for="qaType">Type</label>
              <select id="qaType" required></select>
            </div>
          </div>

          <div class="qa-row">
            <div>
              <label for="qaCat">Category</label>
              <select id="qaCat" required></select>
            </div>
            <div>
              <label for="qaAcct">Account</label>
              <select id="qaAcct" required></select>
            </div>
          </div>

          <div class="qa-row">
            <div>
              <label for="qaAmt">Amount</label>
              <input id="qaAmt" type="number" step="0.01" placeholder="0.00" required>
              <div id="qaAmtError" class="qa-error" aria-live="polite"></div>
            </div>

            <div>
              <label for="qaDesc">Desc</label>
              <input id="qaDesc" type="text" placeholder="What is this, Bunny?" required>
            </div>
          </div>

          <div class="qa-actions">
            <button class="btn secondary" type="button" id="closeQA">Cancel</button>
            <button class="btn primary" type="submit">Add</button>
          </div>
        </form>
      </aside>
    </div>

    <!-- Toast (inside #landing) -->
    <div class="qa-toast" id="qaToast" role="status" aria-live="polite"></div>

    <!-- ü•ö Easter Egg (now INSIDE #landing) -->
    <div class="egg-overlay" id="eggOverlay" aria-hidden="true">
      <aside class="egg-sheet" role="dialog" aria-modal="true" aria-labelledby="eggTitle">
        <div class="egg-head"><div class="egg-grip" style="width:48px;height:5px;border-radius:999px;background:#e6e1dc;opacity:.95;margin:0 auto 8px;"></div></div>
        <h3 id="eggTitle" class="egg-title" style="text-align:center;margin:10px 0 6px;font-weight:800;">BUNNY! WHAT ARE YOU DOING!! THIS IS A SECRET!!</h3>
        <p class="egg-body" style="text-align:center;margin:0 0 8px">You dirty bunny... ü§´<br>Daddy knows what you want, but have you earned it?</p>
        <ul class="egg-perks" style="margin:8px 0 10px 18px">
          <!-- <li>+1 Mischief</li><li>+3 Head Pats</li><li>Unlimited carrot credit (terms absolutely do not apply)</li> -->
        </ul>
        <blockquote class="egg-quote" style="margin:10px 0;padding:10px 12px;background:#fff7e9;border-left:4px solid #f1c27d;border-radius:10px">BAD girrrrrl ‚ú® ‚Ä¶what am I going to do with you...‚Äù</blockquote>
        <div class="egg-actions" style="display:flex;justify-content:center">
          <button class="btn primary" id="eggClose" type="button" style="border-radius:999px;padding:12px 18px;border:1px solid rgba(0,0,0,.06);background:#ebd8c5;font-weight:800">You Yummy ü´¢</button>
        </div>
      </aside>
    </div>

  </div> <!-- /#landing -->

  
  <script>
    
// Prevent double-submit across QA lifecycle
let qaSubmitting = false;

function getSubmitBtn(){ return document.querySelector('#qaForm button[type="submit"]'); }
function resetSubmitBtn(){ const b=getSubmitBtn(); if(!b) return; b.classList.remove('busy'); b.disabled=false; b.textContent='Add'; }
const BASE_URL = '<?= BASE_URL ?>';

    /* QUICK ADD */
    const overlay = document.getElementById('qaOverlay');
    const openBtn = document.getElementById('openQA');
    const closeBtn = document.getElementById('closeQA');
    const qaCloseIcon = document.getElementById('qaCloseIcon');
    const qaToast = document.getElementById('qaToast');

    function showToast(msg){
      if (!qaToast) return;
      qaToast.textContent = msg || 'Saved!';
      qaToast.classList.add('show');
      setTimeout(() => qaToast.classList.remove('show'), 1600);
    }

    function openSheet(){
      // reset Add button each open
      qaSubmitting=false;
      try{ resetSubmitBtn(); }catch(e){}
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      document.body.classList.add('qa-open');
      setTimeout(()=>document.getElementById('qaDate')?.focus(),10);
    }
    function closeSheet(){
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      document.body.classList.remove('qa-open');
    }

    overlay.addEventListener('click', e => { if (e.target === overlay) closeSheet(); });
    openBtn.addEventListener('click', ()=>{ loadMeta(); openSheet(); });
    closeBtn.addEventListener('click', closeSheet);
    qaCloseIcon.addEventListener('click', closeSheet);
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.classList.contains('open')) closeSheet(); });

    const elType = document.getElementById('qaType');
    const elCat  = document.getElementById('qaCat');
    theAcct = document.getElementById('qaAcct');
    const elDate = document.getElementById('qaDate');
    const elAmt  = document.getElementById('qaAmt');
    const elDesc = document.getElementById('qaDesc');

    function fillSelect(sel, values = [], placeholder){
      sel.innerHTML = '';
      if (placeholder){
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = placeholder;
        sel.appendChild(opt);
      }
      values.forEach(v=>{
        const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o);
      });
    }

function loadMeta(){
  // hard-lock Cat/Acct while we fetch meta
  elCat.disabled = true;
  elCat.innerHTML = '<option value="" disabled selected>Retrieving‚Ä¶</option>';
  theAcct.disabled = true;
  theAcct.innerHTML = '<option value="" disabled selected>Retrieving‚Ä¶</option>';

  google.script.run.withSuccessHandler(({accounts, types})=>{
    // Types: ready immediately
    fillSelect(elType, types, 'Choose type');

    // Accounts: prefill in the background BUT keep disabled until Category is chosen
    fillSelect(theAcct, (accounts||[]).slice().sort(), '3) Pick account');
    theAcct.disabled = true; // leave disabled; wizard unlocks after category lands

    // Category stays locked until Type is chosen & cats come back
    elCat.disabled = true;
    elCat.innerHTML = '<option value="" disabled selected>2) Pick category</option>';

    // Date today
    const d=new Date();
    elDate.value = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }).getQuickAddMeta();
}

    document.getElementById('qaForm').addEventListener('submit', (e)=>{
  e.preventDefault();

  if (qaSubmitting) return;
  qaSubmitting = true;

  const submitBtn = getSubmitBtn();
  const prevTxt   = submitBtn ? submitBtn.textContent : null;

  if (submitBtn){
    submitBtn.classList.add('busy');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Good Girrrrrl ‚ú®';
  }
  const controls = Array.from(document.querySelectorAll('#qaForm input, #qaForm select, #qaForm textarea, #qaForm button'));
  controls.forEach(el => { if (el !== submitBtn) el.disabled = true; });

  const openBtn = document.getElementById('openQA');
  if (openBtn) openBtn.disabled = true;

  /* --- INLINE AMOUNT VALIDATION (no popup) --- */
  const amtEl    = document.getElementById('qaAmt');
  const amtErrEl = document.getElementById('qaAmtError');
  const amtVal   = Number(amtEl?.value || 0);

  if (amtErrEl) amtErrEl.textContent = '';
  if (!Number.isFinite(amtVal) || amtVal <= 0) {
    // Stop the submit gracefully
    if (amtErrEl) amtErrEl.textContent = 'Amount must be greater than 0.00';
    if (submitBtn){
      submitBtn.classList.remove('busy');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add';
    }
    controls.forEach(el => { if (el !== submitBtn) el.disabled = false; });
    if (openBtn) openBtn.disabled = false;
    qaSubmitting = false;
    amtEl?.focus();
    return;
  }
  // Clear the error next time the user types
  amtEl?.addEventListener('input', () => { if (amtErrEl) amtErrEl.textContent = ''; }, { once:true });

const payload = {
  date:        document.getElementById('qaDate')?.value || '',
  type:        document.getElementById('qaType')?.value || '',
  category:    document.getElementById('qaCat')?.value || '',
  account:     document.getElementById('qaAcct')?.value || '',
  amount:      Number(document.getElementById('qaAmt')?.value || 0),
  description: document.getElementById('qaDesc')?.value || ''
};

  google.script.run
    .withSuccessHandler(()=>{
      if (submitBtn){
        submitBtn.classList.remove('busy');
        submitBtn.disabled = false;
        if (prevTxt!==null) submitBtn.textContent = prevTxt;
      }
      controls.forEach(el => el.disabled = false);
      if (openBtn) openBtn.disabled = false;

      try { closeSheet(); } catch(e){}
      const elAmt  = document.getElementById('qaAmt');  if (elAmt)  elAmt.value='';
      const elDesc = document.getElementById('qaDesc'); if (elDesc) elDesc.value='';

      qaSubmitting = false;
    })
    .withFailureHandler(err=>{
      if (submitBtn){
        submitBtn.classList.remove('busy');
        submitBtn.disabled = false;
        if (prevTxt!==null) submitBtn.textContent = prevTxt;
      }
      controls.forEach(el => el.disabled = false);
      if (openBtn) openBtn.disabled = false;

      alert('Failed to add. Try again.');
      console.error(err);

      qaSubmitting = false;
    })
    .quickAddTransaction(payload);
});

    /* EASTER EGG (scoped to landing) */
    (() => {
      const bunny = document.getElementById('eggBunny');
      const overlayEgg = document.getElementById('eggOverlay');
      const close   = document.getElementById('eggClose');
      let taps = 0, timer = null, lastPointerId = null;
      const WINDOW_MS = 1500;

      function reset(){ taps = 0; if (timer){ clearTimeout(timer); timer=null; } lastPointerId = null; }
      function openEgg(){
        overlayEgg.classList.add('open'); overlayEgg.setAttribute('aria-hidden','false');
        overlayEgg.dataset.armed = "0"; setTimeout(() => { overlayEgg.dataset.armed = "1"; }, 250);
        if (navigator.vibrate) navigator.vibrate(60);
      }
      function closeEgg(){ overlayEgg.classList.remove('open'); overlayEgg.setAttribute('aria-hidden','true'); }
      function handleTap(ev){
        if (ev.pointerType && ev.isPrimary === false) return;
        if (ev.button !== undefined && ev.button !== 0) return;
        if (ev.pointerId !== undefined){ if (lastPointerId === ev.pointerId) return; lastPointerId = ev.pointerId; }
        bunny.classList.add('bonk'); setTimeout(() => bunny.classList.remove('bonk'), 160);
        if (!timer) timer = setTimeout(reset, WINDOW_MS);
        if (++taps >= 7){ reset(); openEgg(); }
      }
      if (window.PointerEvent){ bunny.addEventListener('pointerdown', handleTap, { passive:true }); }
      else { bunny.addEventListener('touchstart', handleTap, { passive:true }); bunny.addEventListener('click', handleTap); }
      overlayEgg.addEventListener('click', (e)=>{ if (overlayEgg.dataset.armed !== "1") return; if (e.target === overlayEgg) closeEgg(); });
      close.addEventListener('click', closeEgg);
    })();
  </script>

  <!-- === BALUT SPLASH controller (tap to crack ‚Üí open halves; second tap/Skip closes) === -->

  <script>
  // === BALUT SPLASH MASTER SWITCH ===
  // set to "on"  ‚Üí splash runs
  // set to "off" ‚Üí splash is completely disabled
  window.BALUT_SPLASH = "off";
</script>


  <script>
  (function(){
    const splash = document.getElementById('balutSplash');
    if (!splash) return;

      // ‚õî EXIT IMMEDIATELY IF DISABLED
  if (window.BALUT_SPLASH !== "on") {
    splash.remove();  // completely remove from DOM
    return;
  }

    const isMobileish = matchMedia('(hover:none) and (pointer:coarse)').matches;
    const prefersLess = matchMedia('(prefers-reduced-motion: reduce)').matches;

    function openSplash(){ splash.classList.add('open'); }
    function closeSplash(){
      splash.classList.remove('open','crack','confetti','open-egg');
      splash.setAttribute('aria-hidden','true');
    }

    splash.addEventListener('click', (e) => {
      if (e.target instanceof Element && e.target.id === 'balutSkip') { closeSplash(); return; }

      // First tap: crack + confetti, then open the halves
      if (!splash.classList.contains('crack')) {
        splash.classList.add('crack','confetti');
        setTimeout(() => splash.classList.add('open-egg'), 360);
        return;
      }

      // If cracked but not open (edge case): open immediately
      if (!splash.classList.contains('open-egg')) {
        splash.classList.add('open-egg');
        return;
      }

      // If already open: any tap closes
      closeSplash();
    });

if (window.BALUT_SPLASH === "on" && isMobileish && !prefersLess) {
  setTimeout(openSplash, 80);
}

  })();
  </script>

<script>
// BBB_QA_WIZARD_LITE ‚Äî locked until data, "Retrieving‚Ä¶" placeholders, race-proof, and auto-load
(function () {
  const $ = (id) => document.getElementById(id);

  function lockLoading(sel, text){
    if (!sel) return;
    sel.disabled = true;
    sel.setAttribute('aria-busy','true');
    sel.classList.add('select-disabled');
    sel.innerHTML = '';
    const o = document.createElement('option');
    o.value = '';
    o.textContent = text || 'Retrieving‚Ä¶';
    o.disabled = true;
    o.selected = true;
    o.className = 'option-loading';
    sel.appendChild(o);
  }
  function unlockWithOptions(sel, items, placeholder){
    if (!sel) return;
    sel.removeAttribute('aria-busy');
    sel.classList.remove('select-disabled');
    sel.disabled = false;
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = placeholder || 'Choose‚Ä¶';
    ph.disabled = true;
    ph.selected = true;
    sel.appendChild(ph);
    (items || []).forEach(v => {
      const o = document.createElement('option');
      o.value = o.textContent = v;
      sel.appendChild(o);
    });
  }

  // Data fetchers (prefer helpers; fallback to endpoints)
  function fetchCats(type, ok, fail){
    try{
      const r = google?.script?.run;
      if (!r) return fail?.('runner missing');
      if (window.BBL_Helpers?.fetchCategories)
        return BBL_Helpers.fetchCategories(type, ok, fail);
      if (typeof r.listCategoriesByType === 'function')
        return r.withSuccessHandler(ok).withFailureHandler(fail).listCategoriesByType(type);
      fail?.('no category endpoint');
    }catch(e){ fail?.(e); }
  }
  function fetchAccounts(ok, fail){
    try{
      const r = google?.script?.run;
      if (!r) return fail?.('runner missing');
      if (typeof r.BBL_getAccountEstimates === 'function'){
        return r.withSuccessHandler(res=>{
          ok(res && res.ok && res.data ? Object.keys(res.data) : []);
        }).withFailureHandler(fail).BBL_getAccountEstimates();
      }
      if (typeof r.listAccounts === 'function')
        return r.withSuccessHandler(ok).withFailureHandler(fail).listAccounts();
      ok([]);
    }catch(e){ fail?.(e); }
  }

  // Cache + request tokens
  const QACache = { cats: { income:null, expense:null }, accts:null };
  let catReqId = 0, acctReqId = 0;

  function initQAWizard(){
    const elType = $('qaType');
    const elCat  = $('qaCat');
    const elAcct = $('qaAcct');
    if (!elType || !elCat || !elAcct) return;

    // Always start locked
    lockLoading(elCat,  '2) Pick category');
    lockLoading(elAcct, '3) Pick account');

    // Reusable loader (so we can call it on init and on change)
    function loadCatsForCurrentType(){
      const t = String(elType.value || '').toLowerCase();
      const my = ++catReqId;

      // Lock category while loading
      lockLoading(elCat, 'Retrieving categories‚Ä¶');
      // Reset & lock account too
      lockLoading(elAcct, '3) Pick account');

      const finish = (items)=>{
        if (catReqId !== my) return; // stale
        unlockWithOptions(elCat, items || [], '2) Pick category');
      };

      if (QACache.cats[t]) finish(QACache.cats[t]);
      else fetchCats(t,
        (items)=>{ QACache.cats[t]=items||[]; finish(items); },
        (err)=>{ console.error('cats failed', err);
                 if (catReqId !== my) return;
                 unlockWithOptions(elCat, [], 'No categories found'); }
      );
    }

    function loadAccounts(){
      const my = ++acctReqId;
      lockLoading(elAcct, 'Retrieving accounts‚Ä¶');

      const put = (list)=>{
        if (acctReqId !== my) return; // stale
        unlockWithOptions(elAcct, (list||[]).slice().sort(), '3) Pick account');
      };

      if (QACache.accts) put(QACache.accts);
      else fetchAccounts(
        (list)=>{ QACache.accts=list||[]; put(list); },
        (err)=>{ console.error('accounts failed', err);
                 if (acctReqId !== my) return;
                 unlockWithOptions(elAcct, [], 'No accounts found'); }
      );
    }

    // Auto-load categories immediately for whatever Type is currently selected
    if (elType.value) loadCatsForCurrentType();

    // TYPE change -> reload categories
    elType.addEventListener('change', loadCatsForCurrentType, { passive:true });

    // CATEGORY change -> load accounts (only after categories are truly present)
    elCat.addEventListener('change', ()=>{
      if (elCat.disabled) return; // still locked ‚Üí ignore
      loadAccounts();
    }, { passive:true });

    // Submit guard: values only
    const form = document.getElementById('qaForm');
    if (form) form.addEventListener('submit', (e)=>{
      if (!elType.value){ e.preventDefault(); alert('Pick a Type first.'); return; }
      if (!elCat.value){ e.preventDefault(); alert('Pick a Category next.'); return; }
      if (!elAcct.value){ e.preventDefault(); alert('Lastly, pick an Account.'); return; }
    });
  }

  // Init on open and DOM ready
  $('openQA')?.addEventListener('click', ()=> setTimeout(initQAWizard, 50), {passive:true});
  document.addEventListener('DOMContentLoaded', initQAWizard);
})();
</script>

<script id="bbl-custom-required-messages">
(function () {
  // Reusable API
  const BBL_FormMessages = {
    apply(form, messages) {
      if (!form) return;
      const wire = (el, msg) => {
        if (!el) return;
        // keep browser validation, but change the words
        el.addEventListener('invalid', function () {
          this.setCustomValidity(msg || "HEY! Fill this out first, BRAT.");
        });
        // clear custom message as soon as user types/changes
        ['input', 'change'].forEach(evt =>
          el.addEventListener(evt, function () { this.setCustomValidity(''); })
        );
      };
      Object.entries(messages || {}).forEach(([id, msg]) =>
        wire(form.querySelector('#' + id), msg)
      );
    }
  };
  // Expose for reuse on other pages/forms too
  window.BBL_FormMessages = BBL_FormMessages;

  // Auto-wire the QA form when present
  function wireQA() {
    const form = document.getElementById('qaForm');
    if (!form || form.__bblMsgsWired) return;
    BBL_FormMessages.apply(form, {
      qaDate: "Set the date, bunny!",
      qaType: "Bunny! Pick a Type first.",
      qaCat:  "HEY BRAT! Pick a Category next.",
      qaAcct: "Sexy BALUT, pick an Account.",
      qaAmt:  "How broke are you naaa - Enter an amount.",
      qaDesc: "HEY! Fill this out first, BRAT"
    });
    form.__bblMsgsWired = true;
  }

  // Wire on DOM ready and whenever QA opens
  document.addEventListener('DOMContentLoaded', wireQA);
  document.getElementById('openQA')?.addEventListener('click', () => setTimeout(wireQA, 0));
})();
</script>


</body>
</html>
