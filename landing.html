<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Bunny Balut Budget</title>

  <?!= include('styles'); ?>

  <style>
    :root{
      --pad:16px;
      --radius:18px;
      --ink:#3b3532;
      --bg:#f7f4f1;
      --gap:12px;
    }

    body{background:var(--bg);color:var(--ink);}
    .wrap{max-width:1100px;margin:28px auto 56px;padding:0 16px;}

    /* Header */
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .brand .bun{font-size:28px;}
    .brand h1{font-weight:700;font-size:clamp(22px,3.2vw,34px);margin:0}
    .tagline{margin:0 0 18px;opacity:.7;font-size:13.5px}

    /* Cards default */
    .cards{display:flex;flex-direction:column;gap:12px}
    .card{
      background:#fff;border-radius:var(--radius);
      box-shadow:0 6px 18px rgba(0,0,0,.06), inset 0 0 0 1px rgba(0,0,0,.05);
      padding:18px;position:relative
    }
    .kicker{font-weight:600;opacity:.75;font-size:13px}
    .card h3{margin:6px 0 6px;font-size:18px}
    .card p{margin:0 0 12px;opacity:.8}

    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:999px;border:1px solid rgba(0,0,0,.06);
      background:#efe9e2;font-weight:700;cursor:pointer
    }
    .pill.primary{background:#ebd8c5}
    .ribbon{
      position:absolute;right:-48px;top:12px;transform:rotate(20deg);
      padding:6px 0;width:160px;text-align:center;border:1px dashed rgba(0,0,0,.15);
      background:#f3edd9;color:#6a615a;font-weight:700;font-size:12px
    }

    /* Desktop grid only when truly wide */
    @media (min-width:1280px){
      #landing .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    }

    /* ---------- Quick Add modal ---------- */
    .qa-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:9998}
    .qa-overlay.open{display:flex;}
    .qa-sheet{
      width:100%;max-height:100vh;overflow:auto;background:#fff;
      border-top-left-radius:22px;border-top-right-radius:22px;
      padding:18px 16px 20px;z-index:9999;animation:slideUp .22s ease;
    }
    @keyframes slideUp{from{transform:translateY(16px);opacity:.85}to{transform:translateY(0);opacity:1}}
    @media (min-width:980px){
      .qa-overlay{align-items:center;justify-content:center}
      .qa-sheet{width:min(760px,92vw);max-height:86vh;border-radius:22px}
    }

    /* =========================================================
       TOUCH DEVICES: make cards tall AND scale inner typography
       ========================================================= */
    @media (hover:none) and (pointer:coarse){

      /* Bigger header for mobile */
      #landing .brand h1 {
        font-size: clamp(1.9rem, 3.2vh + 1.2rem, 3rem);
        font-weight: 800;
        line-height: 1.1;
      }

      #landing .brand .bun {
        font-size: clamp(2.2rem, 3.5vh + 0.8rem, 3.4rem);
      }

      #landing .tagline {
        font-size: clamp(1rem, 1.1vh + 0.6rem, 1.35rem);
        opacity: .8;
      }

      /* Full-viewport layout for landing so we can size cards */
      #landing.wrap{
        min-height:100svh; display:flex; flex-direction:column;
        margin:0; padding:8px 12px 12px; box-sizing:border-box;
      }
      #landing .brand{margin-bottom:4px}
      #landing .tagline{margin:0 0 8px}

      /* Column of 3 equal slices */
      #landing .cards{
        flex:1 1 auto; min-height:0; display:flex; flex-direction:column; gap:var(--gap);
      }
      #landing .cards > .card{
        width:100%; flex:1 1 0; min-height:22vh; /* fallback */
        display:flex; flex-direction:column; justify-content:center; padding:18px;
      }

      /* ===== Typography that scales with VIEWPORT HEIGHT =====
         These clamps win against base styles because of specificity.
         They track the big chunky cards so text feels proportionate. */
      #landing .cards > .card .kicker{
        font-size:clamp(60px, 1.2vh + 0.45rem, 18px);
        font-weight:700; opacity:.78;
      }
      #landing .cards > .card h3{
        font-size:clamp(40px, 4.6vh + 0.6rem, 28px);
        line-height:1.25; font-weight:800; margin:6px 0 8px;
      }
      #landing .cards > .card p{
        font-size:clamp(20px, 4.6vh + 0.45rem, 19px);
        line-height:1.4; opacity:.88; margin:0 0 14px;
      }
      #landing .cards > .card .pill{
        padding:clamp(40px, 1.3vh + 8px, 18px) clamp(16px, 1.2vh + 12px, 22px);
        font-size:clamp(60px, 1.4vh + 0.5rem, 18px);
        border-radius:999px; font-weight:800;
      }
    }
  </style>
</head>

<body>
  <div id="landing" class="wrap">
    <div class="brand">
      <div class="bun">ğŸ°</div>
      <h1>Bunny Balut Budget</h1>
    </div>
    <p class="tagline">Daddy owns you, and your budget ğŸ¾ğŸ¾ â€” pick your adventure:</p>

    <div class="cards">
      <section class="card">
        <div class="kicker">â• Quick Log</div>
        <h3>Log Your Purchase, Brat</h3>
        <p>Add a transaction fast.</p>
        <button class="pill primary" id="openQA">Open Quick Add</button>
      </section>

      <section class="card">
        <div class="kicker">ğŸ“Š Dashboard</div>
        <h3>Bunny Dashboard &amp; Transactions</h3>
        <p>See Dashboard and transactions</p>
        <a class="pill"
           href="<?= BASE_URL ?>?view=index"
           target="_top" rel="noopener">Open Dashboard</a>
      </section>

      <section class="card">
        <div class="kicker">ğŸ° Profile</div>
        <h3>Manage Bunny Info</h3>
        <p>Categories, accounts, preferencesâ€¦ cozy burrow things.</p>
        <div class="ribbon">COMING SOON</div>
        <button class="pill" disabled>Soonâ„¢</button>
      </section>
    </div>
  </div>

  <!-- Quick Add -->
  <div class="qa-overlay" id="qaOverlay" aria-hidden="true">
    <aside class="qa-sheet" role="dialog" aria-modal="true" aria-labelledby="qaTitle">
      <div class="qa-head"><div class="qa-grip"></div></div>
      <h2 id="qaTitle" class="qa-title" style="text-align:center;margin:10px 0 6px;font-weight:800;">Quick Add</h2>

      <form class="qa-form" id="qaForm" style="display:flex;flex-direction:column;gap:14px">
        <div class="qa-row" style="display:flex;gap:12px">
          <div style="flex:1">
            <label for="qaDate" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Date</label>
            <input id="qaDate" type="date" required style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd">
          </div>
          <div style="flex:1">
            <label for="qaType" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Type</label>
            <select id="qaType" required style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd"></select>
          </div>
        </div>

        <div class="qa-row" style="display:flex;gap:12px">
          <div style="flex:1">
            <label for="qaCat" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Category</label>
            <select id="qaCat" required style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd"></select>
          </div>
          <div style="flex:1">
            <label for="qaAcct" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Account</label>
            <select id="qaAcct" required style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd"></select>
          </div>
        </div>

        <div class="qa-row" style="display:flex;gap:12px">
          <div style="flex:1">
            <label for="qaAmt" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Amount</label>
            <input id="qaAmt" type="number" step="0.01" placeholder="0.00" required style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd">
          </div>
          <div style="flex:1">
            <label for="qaDesc" style="display:block;font-size:13px;font-weight:700;margin-bottom:6px">Desc</label>
            <input id="qaDesc" type="text" placeholder="Optional" style="width:100%;font-size:16px;line-height:1.2;padding:14px 12px;border-radius:12px;border:1px solid #ddd">
          </div>
        </div>

        <div class="qa-actions" style="display:flex;gap:10px;justify-content:space-between;margin-top:2px">
          <button class="btn secondary" type="button" id="closeQA" style="border-radius:999px;padding:12px 16px;border:1px solid rgba(0,0,0,.06);background:#efe9e2;font-weight:800">Cancel</button>
          <button class="btn primary" type="submit" style="border-radius:999px;padding:12px 16px;border:1px solid rgba(0,0,0,.06);background:#ebd8c5;font-weight:800">Add</button>
        </div>
      </form>
    </aside>
  </div>

  <script>
    const BASE_URL = '<?= BASE_URL ?>';

    // QA modal
    const overlay = document.getElementById('qaOverlay');
    const openBtn = document.getElementById('openQA');
    const closeBtn = document.getElementById('closeQA');

    function openSheet(){ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); setTimeout(()=>document.getElementById('qaDate')?.focus(),10); }
    function closeSheet(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); }

    overlay.addEventListener('click', e => { if (e.target === overlay) closeSheet(); });
    openBtn.addEventListener('click', ()=>{ loadMeta(); openSheet(); });
    closeBtn.addEventListener('click', closeSheet);

    // Data loader (same backend as index)
    const elType = document.getElementById('qaType');
    const elCat  = document.getElementById('qaCat');
    const elAcct = document.getElementById('qaAcct');
    const elDate = document.getElementById('qaDate');
    const elAmt  = document.getElementById('qaAmt');
    const elDesc = document.getElementById('qaDesc');

    function fillSelect(sel, values = [], placeholder){
      sel.innerHTML = '';
      if (placeholder){
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = placeholder;
        sel.appendChild(opt);
      }
      values.forEach(v=>{
        const o=document.createElement('option');
        o.value=o.textContent=v;
        sel.appendChild(o);
      });
    }

    function loadMeta(){
      google.script.run.withSuccessHandler(({accounts, types})=>{
        fillSelect(elAcct, accounts, 'Choose account');
        fillSelect(elType, types, 'Choose type');
        const d=new Date(); elDate.value=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
        fillSelect(elCat, [], 'Choose category');
      }).getQuickAddMeta();
    }

    elType.addEventListener('change', ()=>{
      const t = elType.value;
      if (!t){ fillSelect(elCat, [], 'Choose category'); return; }
      google.script.run.withSuccessHandler(cats=>{
        fillSelect(elCat, cats, 'Choose category');
      }).listCategoriesByType(t);
    });

    document.getElementById('qaForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const payload={
        date: elDate.value,
        type: elType.value,
        category: elCat.value,
        amount: elAmt.value,
        account: elAcct.value,
        description: elDesc.value
      };
      openBtn.disabled = true;
      google.script.run
        .withSuccessHandler(()=>{ openBtn.disabled=false; closeSheet(); elAmt.value=''; elDesc.value=''; })
        .withFailureHandler(err=>{ openBtn.disabled=false; alert('Quick Add failed: ' + (err?.message || err)); })
        .quickAddTransaction(payload);
    });
  </script>
</body>
</html>
