<script>
(function () {
  // =========================================================
  // 1. STATE & CONSTANTS
  // =========================================================
  const $ = (id) => document.getElementById(id);
  
  const state = {
    currentMonth: '',
    txPage: 1,
    pageSize: 50,
    loadingCounter: 0 // Centralized loading counter
  };

  // =========================================================
  // 2. CORE UTILITIES (Modal, Render)
  // =========================================================

  function showBusy() {
    state.loadingCounter++; // Increment
    const m = $('busyModal');
    if (m) m.classList.remove('hidden');
  }

  function hideBusy() {
    state.loadingCounter--; // Decrement
    if (state.loadingCounter <= 0) { // Only hide if counter is at or below zero
      state.loadingCounter = 0; // Reset
      const m = $('busyModal');
      if (m) m.classList.add('hidden');
    }
  }

  /** Renders the simple 2D array tables (Summary) */
  function renderArrayTable(el, rows) {
    const tbl = typeof el === 'string' ? $(el) : el;
    tbl.innerHTML = '';
    if (!rows || rows.length === 0) {
      tbl.innerHTML = '<tr><td><em>No data</em></td></tr>';
      return;
    }
    rows.forEach((r, i) => {
      const tr = document.createElement('tr');
      r.forEach((c) => {
        const cell = document.createElement(i === 0 ? 'th' : 'td');
        cell.textContent = c;
        tr.appendChild(cell);
      });
      tbl.appendChild(tr);
    });
  }

  /** Renders the object-array tables (Data Explorer) */
  function renderObjectTable(el, rows, cols) {
    const tableEl = typeof el === 'string' ? $(el) : el;
    if (!tableEl) return;
    
    if (!rows || !rows.length) { 
      tableEl.innerHTML = '<tbody><tr><td class="muted" colspan="'+cols.length+'">No rows</td></tr></tbody>'; 
      return; 
    }
    const thead = '<thead><tr>' + cols.map(c=>`<th>${c.label}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + rows.map(r => '<tr>' + cols.map(c=>`<td>${(r[c.key]??'')}</td>`).join('') + '</tr>').join('') + '</tbody>';
    tableEl.innerHTML = thead + tbody;
  }

  /** Populates a <select> dropdown */
  function populateSelect(elId, items, defaultLabel = 'All') {
    const el = $(elId);
    if (!el) return;
    el.innerHTML = ''; 

    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = `— ${defaultLabel} —`;
    el.appendChild(defOpt);

    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      el.appendChild(opt);
    });
  }
  
  function normalizeMonthStr(s) {
    const m = String(s || '').trim();
    const mm = m.match(/^(\d{4})[-\/.](\d{1,2})$/);
    return mm ? `${mm[1]}-${mm[2].padStart(2,'0')}` : m;
  }

  // =========================================================
  // 3. SERVER CALLS / DATA EXPLORER LOGIC
  // =========================================================

  function refreshBudgets(){
    if (!state.currentMonth) { $('dxPageInfo').textContent=' Set summary month first.'; $('dxBudgets').innerHTML=''; return; }
    
    showBusy();
    google.script.run
      .withSuccessHandler(res => { 
        renderObjectTable('dxBudgets', res.rows, [
          {key:'Month',label:'Month'}, {key:'Type',label:'Type'}, {key:'Category',label:'Category'}, {key:'Budget',label:'Budget'}
        ]); 
        hideBusy();
      })
      .withFailureHandler(e => { 
        $('dxPageInfo').textContent='Error loading budgets: '+(e?.message||e); 
        hideBusy();
      })
      .getBudgetView({ month: state.currentMonth });
  }

  function refreshTransactions(){
    if (!state.currentMonth) { $('dxPageInfo').textContent=' Set summary month first.'; $('dxTx').innerHTML=''; return; }
    
    const type = ($('dxType')||{}).value || '';
    const category = ($('dxCat')||{}).value || '';
    
    showBusy();
    google.script.run
      .withSuccessHandler(res => {
        $('dxPageInfo').textContent = ` Page ${res.page} of ${res.pages} — ${res.total} rows `;
        renderObjectTable('dxTx', res.rows, [
          {key:'DateISO',label:'Date'},{key:'Account',label:'Account'},{key:'Type',label:'Type'},
          {key:'Category',label:'Category'},{key:'Amount',label:'Amount'},{key:'Description',label:'Description'}
        ]);
        state.txPage = res.page;
        hideBusy();
      })
      .withFailureHandler(e => { 
        $('dxPageInfo').textContent='Error loading transactions: '+(e?.message||e); 
        hideBusy();
      })
      .getTransactionView({ 
        month: state.currentMonth, 
        type: type, 
        category: category, 
        page: state.txPage, 
        pageSize: state.pageSize 
      });
  }

  function refreshDataExplorerAll(){ 
    state.txPage = 1; 
    refreshBudgets(); 
    refreshTransactions(); 
  }

  // =========================================================
  // 4. SUMMARY CARD LOGIC (Moved from index.html)
  // =========================================================

  function readMonthISO() {
    const iMonth = $('isoMonth');
    if (!iMonth) return '';
    if (iMonth.type === 'month') return iMonth.value || '';
    const mm = String(iMonth.value || '').padStart(2, '0');
    const yyyy = new Date().getFullYear();
    return mm ? `${yyyy}-${mm}` : '';
  }

  function handleSetMonthSuccess(iso, res) {
    const btn = $('btnApplyMonth');
    btn.textContent = 'Set Month';
    btn.classList.remove('busy');

    $('monthStatus').textContent = `✓ Set to ${res.b4}`;

    // Render the summary tables
    if (typeof renderArrayTable === 'function') {
      renderArrayTable('tblActVsBud', res.actVsBud);
      renderArrayTable('tblIncome', res.income);
      renderArrayTable('tblExpense', res.expense);
    }
    
    // Bridge to Data Explorer (Internal Logic - No CustomEvent needed!)
    const norm = normalizeMonthStr(iso);
    const includeTx = !!($('includeTx') && $('includeTx').checked);

    state.currentMonth = norm;
    $('dxMonthBadge').textContent = 'Month: ' + norm;

    if (includeTx) {
      refreshDataExplorerAll();
    }
    
    // This hideBusy() balances the showBusy() call from handleSetMonthClick
    hideBusy();
  }
  
  function handleSetMonthFailure(err) {
    const btn = $('btnApplyMonth');
    const status = $('monthStatus');
    btn.textContent = 'Set Month';
    btn.classList.remove('busy');
    
    hideBusy(); 
    
    const msg = (err && err.message) ? err.message : 'Unknown error';
    if (status) status.textContent = 'Error: ' + msg;
    alert('Set Month failed: ' + msg);
  }

  function handleSetMonthClick() {
    const iso = readMonthISO();
    if (!iso) { alert('Please select a month first.'); return; }
    
    const btn = $('btnApplyMonth');
    btn.textContent = 'Good Girrrrrl ✨';
    btn.classList.add('busy');
    
    showBusy(); 
    $('monthStatus').textContent = '';

    google.script.run
      .withSuccessHandler(res => handleSetMonthSuccess(iso, res))
      .withFailureHandler(handleSetMonthFailure)
      .setSummaryMonthFromIso(iso);
  }


  // =========================================================
  // 5. INITIALIZATION
  // =========================================================

  function initializeDropdowns() {
    // Start with empty tables
    renderArrayTable('tblActVsBud', []);
    renderArrayTable('tblIncome', []);
    renderArrayTable('tblExpense', []);
    renderObjectTable('dxBudgets', [], [{label: 'Loading...', key: 'Month'}]); // Placeholder
    renderObjectTable('dxTx', [], [{label: 'Loading...', key: 'DateISO'}]);    // Placeholder

    // Fetch the Type list and populate the dropdown
    showBusy(); 
    google.script.run
      .withSuccessHandler(items => {
        populateSelect('dxType', items, 'All Types');
        hideBusy();
      })
      .withFailureHandler(err => {
        console.error('Failed to load types: ' + (err.message || err));
        hideBusy();
      })
      .listTypes();
    
    // Fetch the Category list and populate the dropdown
    showBusy();
    google.script.run
      .withSuccessHandler(items => {
        populateSelect('dxCat', items, 'All Categories');
        hideBusy();
      })
      .withFailureHandler(err => {
        console.error('Failed to load categories: ' + (err.message || err));
        hideBusy();
      })
      .listCategories();
  }


  document.addEventListener('DOMContentLoaded', () => {
    // Initialize content and fetch initial dropdown data
    initializeDropdowns();
    
    // Event listeners for the Summary Card (from index.html)
    const btnApplyMonth = $('btnApplyMonth');
    if (btnApplyMonth) {
      btnApplyMonth.addEventListener('click', handleSetMonthClick);
    }

    // Event listeners for the Data Explorer (pagination/filtering)
    $('dxRefresh').addEventListener('click', refreshDataExplorerAll);
    
    // When Type/Category filters change, reset page and refresh transactions
    $('dxType').addEventListener('change', () => { state.txPage = 1; refreshTransactions(); });
    $('dxCat').addEventListener('change', () => { state.txPage = 1; refreshTransactions(); });
    
    // Pagination buttons
    $('dxPrev').addEventListener('click', () => { 
      if (state.txPage > 1) { 
        state.txPage--; 
        refreshTransactions(); 
      }
    });
    $('dxNext').addEventListener('click', () => { 
      state.txPage++; // Assume next page exists, let the handler correct if necessary
      refreshTransactions(); 
    });
    
    // Initial load: Try to load data if month is already set (e.g., if we were debugging)
    // NOTE: If the app loaded without a month in B4, this does nothing.
    google.script.run
        .withSuccessHandler(res => {
            if (res.iso) {
                state.currentMonth = res.iso;
                $('dxMonthBadge').textContent = 'Month: ' + res.iso;
                refreshDataExplorerAll();
            }
        })
        .getCurrentMonthIso();

  });
})();
</script>