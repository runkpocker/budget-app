<script>
// ---------- Helpers ----------
const qs = (id) => document.getElementById(id);

// --- NEW: Loading Counter ---
let loadingCounter = 0;

// ---------- Modal controls (UPDATED) ----------
function showBusy() {
  loadingCounter++; // Increment
  const m = qs('busyModal');
  if (m) m.classList.remove('hidden');
}
function hideBusy() {
  loadingCounter--; // Decrement
  if (loadingCounter <= 0) { // Only hide if counter is at or below zero
    loadingCounter = 0; // Reset
    const m = qs('busyModal');
    if (m) m.classList.add('hidden');
  }
}

// --- Busy message helpers ---
const busyState = { budgets: false, tx: false };

function setBusyMessage(text) {
  const el = document.getElementById('busyModal');
  const t = el ? el.querySelector('.modal-text') : null;
  if (t) t.textContent = text;
}

function updateBusyMessage() {
  const b = busyState.budgets, t = busyState.tx;
  if (b && t)      setBusyMessage('Fetching budgets & transactions (2 tasks)…');
  else if (b)      setBusyMessage('Fetching budgets (1/2)…');
  else if (t)      setBusyMessage('Fetching transactions (1/2)…');
  else             setBusyMessage('Hang on to your Bunny Hairs, Daddy is getting the info...'); // default
}

// ---------- Table renderer ----------
function renderTable(el, rows) {
  const tbl = typeof el === 'string' ? qs(el) : el;
  tbl.innerHTML = '';
  if (!rows || rows.length === 0) {
    tbl.innerHTML = '<tr><td><em>No data</em></td></tr>';
    return;
  }
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    r.forEach((c) => {
      const cell = document.createElement(i === 0 ? 'th' : 'td');
      cell.textContent = c;
      tr.appendChild(cell);
    });
    tbl.appendChild(tr);
  });
}

// ---------- Init ----------
function init() {
  const btn = qs('btnApplyMonth');

  // Start clean: no month selected, no data tables populated
  renderTable('tblActVsBud', []);
  renderTable('tblIncome', []);
  renderTable('tblExpense', []);
}

document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
   window.__summaryMonth = window.__summaryMonth || ''; // 'YYYY-MM' format 
  let __summaryMonthDisplay = ''; // 'Month YYYY' or 'Mmm-yy' format
  let txPage = 1;
  const pageSize = 50;

  /**
   * Populates a <select> dropdown with a list of items.
   */
  function populateSelect(elId, items, defaultLabel = 'All') {
    const el = $(elId);
    if (!el) return;
    el.innerHTML = ''; // Clear existing options

    // Add the default "All" option
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = `— ${defaultLabel} —`;
    el.appendChild(defOpt);

    // Add items from the server
    items.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      el.appendChild(opt);
    });
  }

  function normalizeMonthStr(s) {
    const m = String(s || '').trim();
    const mm = m.match(/^(\d{4})[-\/.](\d{1,2})$/);
    return mm ? `${mm[1]}-${mm[2].padStart(2,'0')}` : m;
  }
 
   function currentMonthISO(){ return normalizeMonthStr(window.__summaryMonth || ''); }

  /** Formats 'YYYY-MM' to 'Mmm-yy' (e.g., '2025-10' to 'Oct-25') */
  function formatIsoToMmmYy(iso) {
    if (!iso || !/^\d{4}-\d{2}$/.test(iso)) return 'N/A';
    try {
      const [y, m] = iso.split('-');
      // Use day 2 to avoid any 1-day timezone shifts
      const d = new Date(Number(y), Number(m) - 1, 2); 
      const mmm = d.toLocaleString('default', { month: 'short' });
      const yy = d.getFullYear().toString().slice(-2);
      return `${mmm}-${yy}`;
    } catch (e) {
      return iso; // Fallback to original string
    }
  }

  function renderTable(el, rows, cols) {
    if (!el) return;
    if (!rows || !rows.length) { el.innerHTML = '<tbody><tr><td class="muted" colspan="'+cols.length+'">No rows</td></tr></tbody>'; return; }
    const thead = '<thead><tr>' + cols.map(c=>`<th>${c.label}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + rows.map(r => '<tr>' + cols.map(c=>`<td>${(r[c.key]??'')}</td>`).join('') + '</tr>').join('') + '</tbody>';
    el.innerHTML = thead + tbody;
  }

  function refreshBudgets(){
    const month = currentMonthISO();
    const el = $('dxBudgets'); 
    if (!el) return;
    if (!month){ if(info) info.textContent=' Set summary month first.'; el.innerHTML=''; return; }

    // NEW: mark budgets as running and update modal message
    busyState.budgets = true;
    updateBusyMessage();
    
  showBusy();
  google.script.run
    .withSuccessHandler(res => {
      renderTable(el, res.rows, [
        {key:'Month',label:'Month'}, {key:'Type',label:'Type'}, {key:'Category',label:'Category'}, {key:'Budget',label:'Budget'}
      ]);
      // NEW: clear budgets flag and update message
      busyState.budgets = false;
      updateBusyMessage();
      hideBusy();
    })
    .withFailureHandler(e => {
      if(info) info.textContent='Error: '+(e?.message||e);
      // NEW: clear budgets flag and update message
      busyState.budgets = false;
      updateBusyMessage();
      hideBusy();
    })
    .getBudgetView({ month });
  }

  function refreshTransactions(){
    const month = currentMonthISO();
    const el = $('dxTx'); 
    if (!el) return;
    if (!month){ if(info) info.textContent=' Set summary month first.'; el.innerHTML=''; return; }
    const type = ($('dxType')||{}).value || '';
    const category = ($('dxCat')||{}).value || '';
    
    busyState.tx = true;
    updateBusyMessage();

    showBusy(); 
    google.script.run
.withSuccessHandler(res => {
  renderTable(el, res.rows, [
    {key:'DateISO',label:'Date'},{key:'Account',label:'Account'},{key:'Type',label:'Type'},
    {key:'Category',label:'Category'},{key:'Amount',label:'Amount'},{key:'Description',label:'Description'}
  ]);
      busyState.tx = false;
      updateBusyMessage();
      hideBusy();
  //txPage = 1; // keep stable
  
})
      .withFailureHandler(e => { 
        if(info) info.textContent='Error: '+(e?.message||e); 
        hideBusy(); 
      })
      .getTransactionView({ month, type, category, page: 1, pageSize: 1000 });
  }

  window.refreshDataExplorerAll = function(){ try{ txPage=1; refreshBudgets(); refreshTransactions(); }catch(e){ console.warn(e);} };

  document.addEventListener('DOMContentLoaded', () => {
const ref = document.getElementById('dxRefresh');
if (ref) ref.addEventListener('click', () => {
  const prev = ref.textContent;
  ref.textContent = 'Good Girrrrrl ✨';
  ref.classList.add('busy');

  try {
    // This calls refreshBudgets() + refreshTransactions()
    // Both already do showBusy()/hideBusy() around their server calls.
    if (typeof window.refreshDataExplorerAll === 'function') {
      window.refreshDataExplorerAll();
    }
  } finally {
    // Button vibe lasts briefly; the popup is handled by inner calls.
    setTimeout(() => {
      ref.textContent = prev;
      ref.classList.remove('busy');
    }, 1200);
  }
});



    const t = $('dxType'); if (t) t.addEventListener('change', ()=>{ txPage=1; refreshTransactions(); });
    const c = $('dxCat'); if (c) c.addEventListener('change', ()=>{ txPage=1; refreshTransactions(); });
 
    // ⛔ No auto-month fetch here.
    // Badge stays "Month Set: not set" until Set Month is clicked.

    // Preload dropdowns only
    showBusy(); 
    google.script.run
      .withSuccessHandler(items => {
        populateSelect('dxType', items, 'All Types');
        hideBusy(); 
      })
      .withFailureHandler(err => {
        console.error('Failed to load types: ' + (err.message || err));
        hideBusy(); 
      })
      .listTypes();
    
    showBusy(); 
    google.script.run
      .withSuccessHandler(items => {
        populateSelect('dxCat', items, 'All Categories');
        hideBusy(); 
      })
      .withFailureHandler(err => {
        console.error('Failed to load categories: ' + (err.message || err));
        hideBusy(); 
      })
      .listCategories();
  });
})();
</script>

<script>
/* FINAL EVENT LISTENER */
document.addEventListener('summary-month-set', function(e) {
  // Read payload from Set Month flow
  const iso = e.detail && e.detail.month ? e.detail.month : '';
  const includeTx = e.detail && e.detail.includeTx;
  const displayMonth = e.detail && e.detail.displayMonth ? e.detail.displayMonth : '';

  if (iso) {
    // 1. Update the global month variable
    window.__summaryMonth = iso; // 'YYYY-MM'

    // 2. Update the visual badge
    const badge = document.getElementById('dxMonthBadge');
    if (badge) badge.textContent = 'Month Set: ' + displayMonth;

    // 3. Optionally refresh Data Explorer
    if (includeTx && typeof window.refreshDataExplorerAll === 'function') {
      window.refreshDataExplorerAll();
    }
  }

  // Balance the modal counter (paired with showBusy on Set Month click)
  hideBusy();
});
</script>
