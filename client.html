<script>
// ---------- Helpers ----------
const qs = (id) => document.getElementById(id);

// Loading counter for the modal
let loadingCounter = 0;
let retryTimer = null;

// ---------- Modal controls (Consolidated) ----------
function showBusy() {
  loadingCounter++;
  const m = qs('busyModal');
  if (m) {
    m.classList.remove('hidden');
    document.body.classList.add('bb-busy'); // Styling hook
    
    // Start "slow network" hint timer
    clearTimeout(retryTimer);
    retryTimer = setTimeout(() => {
      const t = m.querySelector('.modal-text');
      if (loadingCounter > 0 && t) {
        t.textContent = "This carrot patch is thicc ðŸ¥•ðŸ¥• â€” still fetchingâ€¦ try again if it stalls.";
      }
    }, 15000);
  }
}

function hideBusy() {
  loadingCounter--;
  if (loadingCounter <= 0) {
    loadingCounter = 0;
    clearTimeout(retryTimer);
    const m = qs('busyModal');
    if (m) m.classList.add('hidden');
    document.body.classList.remove('bb-busy');
  }
}

// Busy message helpers (kept for summary + data fetches)
const busyState = { budgets: false, tx: false };
function setBusyMessage(text) {
  const el = document.getElementById('busyModal');
  const t = el ? el.querySelector('.modal-text') : null;
  if (t) t.textContent = text;
}
function updateBusyMessage() {
  const b = busyState.budgets, t = busyState.tx;
  if (b && t)      setBusyMessage('Fetching budgets & transactions (2 tasks)â€¦');
  else if (b)      setBusyMessage('Fetching budgets (1/2)â€¦');
  else if (t)      setBusyMessage('Fetching transactions (1/2)â€¦');
  else             setBusyMessage('Hang on to your Bunny Hairs, Daddy is getting the info...');
}

// ---- Summary renderer compatibility shim ----
// Summary's Set Month flow still calls `renderTable(elOrId, rows)`.
// Point it to the new simple renderer so nothing else needs to change.
window.renderTable = function renderTableCompat(elOrId, rows) {
  // uses the simple array-of-arrays renderer we defined
  if (typeof renderSimpleTable === 'function') {
    renderSimpleTable(elOrId, rows);
  } else {
    // ultra-safe fallback in case someone deletes that too
    const el = typeof elOrId === 'string' ? document.getElementById(elOrId) : elOrId;
    if (!el) return;
    el.innerHTML = '';
    (rows || []).forEach((r, i) => {
      const tr = document.createElement('tr');
      (r || []).forEach(c => {
        const cell = document.createElement(i === 0 ? 'th' : 'td');
        cell.textContent = c;
        tr.appendChild(cell);
      });
      el.appendChild(tr);
    });
    if (!rows || !rows.length) el.innerHTML = '<tr><td><em>No data</em></td></tr>';
  }
};

// ---------- Summary tables (left as-is) ----------
function renderSimpleTable(el, rows) {
  const tbl = typeof el === 'string' ? qs(el) : el;
  tbl.innerHTML = '';
  if (!rows || rows.length === 0) {
    tbl.innerHTML = '<tr><td><em>No data</em></td></tr>';
    return;
  }
  rows.forEach((r, i) => {
    const tr = document.createElement('tr');
    r.forEach((c) => {
      const cell = document.createElement(i === 0 ? 'th' : 'td');
      cell.textContent = c;
      tr.appendChild(cell);
    });
    tbl.appendChild(tr);
  });
}

// ---------- Data Explorer helpers ----------
(function(){
  const $ = (id) => document.getElementById(id);
  window.__summaryMonth = window.__summaryMonth || ''; // 'YYYY-MM'
  let txPage = 1;

  // Small helpers to build selects
  function populateSelectAllMode(elId, items, allLabel = 'All') {
    const el = $(elId);
    if (!el) return;
    el.innerHTML = '';
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = `â€” ${allLabel} â€”`;
    el.appendChild(defOpt);
    (items || []).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
  }
  function populateSelectChooseMode(elId, items, chooseLabel = 'Chooseâ€¦') {
    const el = $(elId);
    if (!el) return;
    el.innerHTML = '';
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = chooseLabel;
    defOpt.disabled = true;
    defOpt.selected = true;
    el.appendChild(defOpt);
    (items || []).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      el.appendChild(opt);
    });
  }

  function normalizeMonthStr(s) {
    const m = String(s || '').trim();
    const mm = m.match(/^(\d{4})[-\/.](\d{1,2})$/);
    return mm ? `${mm[1]}-${mm[2].padStart(2,'0')}` : m;
  }
  function currentMonthISO(){ return normalizeMonthStr(window.__summaryMonth || ''); }

  // Data Explorer table renderer
  function renderTable(el, rows, cols) {
    if (!el) return;
    if (!rows || !rows.length) {
      el.innerHTML = '<tbody><tr><td class="muted" colspan="'+(cols?.length||1)+'">No rows</td></tr></tbody>';
      return;
    }
    const thead = '<thead><tr>' + cols.map(c=>`<th>${c.label}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + rows.map(r => '<tr>' + cols.map(c=>`<td>${(r[c.key]??'')}</td>`).join('') + '</tr>').join('') + '</tbody>';
    el.innerHTML = thead + tbody;
  }

  // ===== CATEGORY LOADERS =====
  // DF: instant, NO MODAL
  function loadCategoriesByType_ForDF(typeValue) {
    BBL_Helpers.fetchCategories(typeValue || '', (items) => {
      populateSelectAllMode('dxCat', items, 'All Categories');
    }, (err) => {
      console.error('DF cats load failed:', err?.message || err);
      populateSelectAllMode('dxCat', [], 'All Categories');
    });
  }

  // QA: instant, NO MODAL
  function loadCategoriesByType_ForQA(typeValue) {
    BBL_Helpers.fetchCategories(typeValue || '', (items) => {
      populateSelectChooseMode('qaCat', items, 'Choose category');
    }, (err) => {
      console.error('QA cats load failed:', err?.message || err);
      populateSelectChooseMode('qaCat', [], 'No categories');
    });
  }

  // ===== FETCHERS THAT USE MODAL (heavy) =====
  function refreshBudgets(){
    const month = currentMonthISO();
    const el = $('dxBudgets'); 
    if (!el) return;

    if (!month){
      const badge = $('dxMonthBadge');
      if (badge) badge.textContent = 'Month Set: not set (pick a month above)';
      el.innerHTML = '';
      return;
    }

    busyState.budgets = true;
    updateBusyMessage();
    showBusy();

    google.script.run
      .withSuccessHandler(res => {
        renderTable(el, res.rows, [
          {key:'Month',label:'Month'}, {key:'Type',label:'Type'},
          {key:'Category',label:'Category'}, {key:'Budget',label:'Budget'}
        ]);
        busyState.budgets = false; updateBusyMessage(); hideBusy();
      })
      .withFailureHandler(e => {
        busyState.budgets = false; updateBusyMessage();
        el.innerHTML = '<tbody><tr><td>Error loading budgets</td></tr></tbody>';
        hideBusy();
        console.error('Budgets error:', e && e.message ? e.message : e);
      })
      .getBudgetView({ month });
  }

  function refreshTransactions(){
    const month = currentMonthISO();
    const el = $('dxTx'); 
    if (!el) return;

    if (!month){
      const badge = $('dxMonthBadge');
      if (badge) badge.textContent = 'Month Set: not set (pick a month above)';
      el.innerHTML = '';
      return;
    }

    const type = ($('dxType')||{}).value || '';
    const category = ($('dxCat')||{}).value || '';

    busyState.tx = true;
    updateBusyMessage();
    showBusy();

    google.script.run
      .withSuccessHandler(res => {
        // ðŸ”¥ Force newest-first by DateISO (YYYY-MM-DD) before rendering
        let rows = Array.isArray(res.rows) ? res.rows.slice() : [];
        if (rows.length) {
          rows.sort((a, b) => {
            const ad = String(a.DateISO || '').trim();
            const bd = String(b.DateISO || '').trim();
            // handle blanks sanely: blanks go to the bottom
            if (!ad && !bd) return 0;
            if (!ad) return 1;
            if (!bd) return -1;
            // ISO dates compare correctly as strings
            return bd.localeCompare(ad); // newest first
          });
        }

        renderTable(el, rows, [
          {key:'DateISO',label:'Date'},{key:'Account',label:'Account'},
          {key:'Type',label:'Type'},{key:'Category',label:'Category'},
          {key:'Amount',label:'Amount'},{key:'Description',label:'Description'}
        ]);
        busyState.tx = false; updateBusyMessage(); hideBusy();
      })
      .withFailureHandler(e => {
        busyState.tx = false; updateBusyMessage();
        el.innerHTML = '<tbody><tr><td>Error loading transactions</td></tr></tbody>';
        hideBusy();
        console.error('TX error:', e && e.message ? e.message : e);
      })
      .getTransactionView({ month, type, category, page: 1, pageSize: 1000 });
  }

  window.refreshDataExplorerAll = function(){
    try { txPage=1; refreshBudgets(); refreshTransactions(); } catch(e){ console.warn(e);}
  };

  // ===== BOOTSTRAP =====
  document.addEventListener('DOMContentLoaded', () => {
    // DF Types (All Types)
    google.script.run
      .withSuccessHandler(items => {
        populateSelectAllMode('dxType', items, 'All Types');
        // Initial DF cats = union (blank type)
        loadCategoriesByType_ForDF('');
      })
      .withFailureHandler(err => {
        console.error('Failed to load types for DF:', err?.message || err);
        populateSelectAllMode('dxType', [], 'All Types');
        populateSelectAllMode('dxCat',  [], 'All Categories');
      })
      .listTypes();

    // DF: on type change â€” ONLY rebuild categories, DO NOT open modal nor auto-refresh data
    const t = $('dxType');
    if (t) t.addEventListener('change', () => {
      const typeVal = t.value || '';
      loadCategoriesByType_ForDF(typeVal);
      // (User will hit "Refresh Transactions" when ready)
    });

    // DF: Category change also should NOT open modal â€” wait for explicit refresh
    const c = $('dxCat');
    if (c) c.addEventListener('change', () => {
      // noop; user clicks Refresh when ready
    });

    // Refresh button (brings the modal, as intended)
    const ref = $('dxRefresh');
    if (ref) ref.addEventListener('click', () => {
      const prev = ref.textContent;
      ref.textContent = 'Good Girrrrrl âœ¨';
      ref.classList.add('busy');
      try {
        if (typeof window.refreshDataExplorerAll === 'function') {
          window.refreshDataExplorerAll();
        }
      } finally {
        setTimeout(() => {
          ref.textContent = prev;
          ref.classList.remove('busy');
        }, 1200);
      }
    });
  });
})();
</script>

<script>
/* SUMMARY â†’ DF bridge */
document.addEventListener('summary-month-set', function(e) {
  const iso = e.detail && e.detail.month ? e.detail.month : '';
  const includeTx = e.detail && e.detail.includeTx;
  const displayMonth = e.detail && e.detail.displayMonth ? e.detail.displayMonth : '';

  if (iso) {
    window.__summaryMonth = iso;
    const badge = document.getElementById('dxMonthBadge');
    if (badge) badge.textContent = 'Month Set: ' + displayMonth;
    if (includeTx && typeof window.refreshDataExplorerAll === 'function') {
      window.refreshDataExplorerAll();
    }
  }
  hideBusy();
});
</script>

<script>
(function () {
  const $ = (id) => document.getElementById(id);
  const f = $('qaForm');
  if (!f) return;

  let metaLoaded = false;
  const el = {
    date: $('qaDate'), type: $('qaType'), cat: $('qaCat'),
    amt: $('qaAmt'),  acct: $('qaAcct'), desc: $('qaDesc'),
    btn: $('qaSubmit'), refreshBtn: $('dxRefresh')
  };

  function setBusy(on) {
    try {
      el.btn.disabled = on || !metaLoaded;
      if (on) { el.btn.classList.add('busy'); showBusy(); }
      else { el.btn.classList.remove('busy'); hideBusy(); }
    } catch(_) {}
  }

  // ---- RETRY WRAPPER (handles transient 429) ----
  function runWithRetry(fnName, args, onOk, onErr, tries=3, delay=350) {
    function attempt(remaining) {
      google.script.run
        .withSuccessHandler(onOk)
        .withFailureHandler((e) => {
          const msg = String(e && e.message || e || '');
          if (remaining > 0 && (msg.includes('429') || msg.includes('Rate') || msg.includes('quota'))) {
            setTimeout(() => attempt(remaining - 1), delay);
          } else {
            onErr(e);
          }
        })[fnName](args);
    }
    attempt(tries);
  }

  // ---- Load QA meta once; enable button when ready ----
  setBusy(true);
  runWithRetry('getQuickAddMeta', null, (res) => {
      const meta = res || {accounts:[], types:[]};
      // fill selects (same as you had)
      const fill = (sel, items, ph) => {
        sel.innerHTML='';
        if (ph){ const o=document.createElement('option'); o.value=''; o.textContent=ph; o.disabled=true; o.selected=true; sel.appendChild(o); }
        items.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); });
      };
      fill(el.type, meta.types, null);
      fill(el.acct, meta.accounts, 'Choose account');

      // Defaults you want
      el.type.value = 'Expense';
      try { el.date.valueAsDate = new Date(); } catch(_) {}

      // Trigger category load for default type without showing the global modal
      loadCatsFor(el.type.value, 'qaCat', false);

      metaLoaded = true;
      setBusy(false);
  }, (err) => {
      setBusy(false);
      alert('Failed to load Quick Add options: ' + (err?.message || err));
  });

  // ---- Category loader for a given type (reuse for DF + QA) ----
  function loadCatsFor(type, targetId, useModal=true){
    const after = (items) => {
      const target = $(targetId);
      const populate = (sel, arr, ph) => {
        sel.innerHTML='';
        if (ph){ const o=document.createElement('option'); o.value=''; o.textContent=ph; o.disabled=true; o.selected=true; sel.appendChild(o); }
        (arr||[]).forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); });
      };
      const ph = (targetId === 'dxCat') ? 'â€” All Categories â€”' : 'Choose category';
      populate(target, items, ph);
      if (targetId === 'qaCat' && items && items.length) target.value = items[0];
      if (useModal) hideBusy();
    };
    const fail = (e) => { if (useModal) hideBusy(); console.error('loadCatsFor failed', e); };

    if (useModal) showBusy();
    BBL_Helpers.fetchCategories(String(type || ''), after, fail);
  }

  // When QA Type changes, reload QA cats (no modal)
  el.type.addEventListener('change', () => loadCatsFor(el.type.value, 'qaCat', false));

  // ---- Submit ----
  f.addEventListener('submit', function (e) {
    e.preventDefault();
    if (!metaLoaded) { alert('Still loading optionsâ€”one sec.'); return; }

    const payload = {
      date: el.date.value,
      type: el.type.value,
      category: el.cat.value,
      amount: el.amt.value,
      account: el.acct.value,
      description: el.desc.value
    };
    if (!payload.date || !payload.type || !payload.category || !payload.amount || !payload.account) {
      alert('Fill the required fields, dear bunny.');
      return;
    }

    setBusy(true);
    runWithRetry('quickAddTransaction', payload, (r) => {
        el.amt.value = '';
        el.desc.value = '';
        if (el.refreshBtn) el.refreshBtn.click();
        setBusy(false);
    }, (err) => {
        setBusy(false);
        alert('Quick Add failed: ' + (err?.message || err));
    });
  });

  // ---- Data Filter Type change â†’ reload DF cats (instant, no modal) ----
  const dft = $('dxType'), dfc = $('dxCat');
  if (dft && dfc) dft.addEventListener('change', () => loadCatsFor(dft.value, 'dxCat', false));
})();
</script>

<script>
// ---------- Summary init (keep your original simple tables empty on boot) ----------
document.addEventListener('DOMContentLoaded', function(){
  renderSimpleTable('tblActVsBud', []);
  renderSimpleTable('tblIncome', []);
  renderSimpleTable('tblExpense', []);
});
</script>

<script>
/* ðŸ”’ BBL compatibility helpers â€” add-only, zero UX change */
(function(){
  function runner(){ return (google && google.script && google.script.run) || null; }

  // Categories (income | expense)
  window.BBL_Helpers = {
    fetchCategories: function(type, onOk, onFail){
      var r = runner(); if (!r) return (onFail && onFail('runner missing'));
      if (typeof r.BBL_listCategoriesByType === 'function') {
        r.withSuccessHandler(function(res){ if(res && res.ok){ onOk && onOk(res.data); } else { onFail && onFail(res); } })
         .withFailureHandler(function(err){ onFail && onFail(err); })
         .BBL_listCategoriesByType(type);
      } else if (typeof r.listCategoriesByType === 'function') {
        // fallback to your original endpoint
        r.withSuccessHandler(function(data){ onOk && onOk(data); })
         .withFailureHandler(function(err){ onFail && onFail(err); })
         .listCategoriesByType(type);
      } else {
        onFail && onFail('No categories endpoint found');
      }
    },

    getAccountEstimates: function(onOk, onFail){
      var r = runner(); if (!r) return (onFail && onFail('runner missing'));
      if (typeof r.BBL_getAccountEstimates === 'function') {
        r.withSuccessHandler(function(res){ if(res && res.ok){ onOk && onOk(res.data); } else { onFail && onFail(res); } })
         .withFailureHandler(function(err){ onFail && onFail(err); })
         .BBL_getAccountEstimates();
      } else if (typeof r.getAccountEstimates === 'function') {
        // fallback to your original endpoint
        r.withSuccessHandler(function(data){ onOk && onOk(data); })
         .withFailureHandler(function(err){ onFail && onFail(err); })
         .getAccountEstimates();
      } else {
        onFail && onFail('No account estimates endpoint found');
      }
    }
  };
})();
</script>